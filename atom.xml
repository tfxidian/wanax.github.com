<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[陋室]]></title>
  <link href="http://sonnewilling.com/atom.xml" rel="self"/>
  <link href="http://sonnewilling.com/"/>
  <updated>2015-06-30T01:26:01+08:00</updated>
  <id>http://sonnewilling.com/</id>
  <author>
    <name><![CDATA[Wanax]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[蛮荒记]]></title>
    <link href="http://sonnewilling.com/blog/2015/06/26/man-huang-ji/"/>
    <updated>2015-06-26T00:32:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2015/06/26/man-huang-ji</id>
    <content type="html"><![CDATA[<h2>0.1 无关紧要的废话</h2>

<blockquote><p>好久没写东西了。</p>

<p>虽说也是天天敲键盘，总归代码跟字不同。字是自己磨出来的，然而并没有什么卵用，自己无聊的时候回来看看解解闷罢了。代码迥然，我们不生产代码，我们只是github的搬运工，搬出来的却实打实的口粮，能面朝大海春暖花开。</p></blockquote>

<h2>1.0 启程</h2>

<p>6月17日踏上了飞往普及的航班，天气不错，亚航多事故心下惴惴，好在一路无事安全降落。120块便办好了入境签证，不过四五分钟，比去隔海相望的香港要来得简单。</p>

<p>出了机场后并没有遇到想象中的热带炎热，反而是略带咸湿的海风吹得遍体通透。想着在深圳每早赶着公交都是一身臭汗，已觉此行不虚，余下便是尽情享受。</p>

<!--more-->


<p>深夜迷糊中听着一场大雨一阵雷，又沉沉睡去。早上醒来巡视一圈住处，不过一个方形小院，老板一直就在左边的尖顶屋子里看书喝茶，我看来寂寞蛋碎的一天不知此人如何熬住。果然如游戏中的NPC，时间对其来说不过一个设定吗？传说中的四维生物，可以在时间线中跳跃。</p>

<h2>2.0 上岛</h2>

<p>普吉岛并没有什么游玩的计划，早上起来吃过早餐就准备着中午的大船去临近的皮皮岛（PhiPhi Island），那里计划住五天，搞定潜水证，算大功告成。</p>

<h4>2.1 岛上下榻</h4>

<p>小岛不大，开发出来的地儿也就仅仅占着几个沙滩而已。也省了许多逛街的麻烦。每天吃的不外是厚牛肉汉堡，刚捞出来的炸鸡和切好的各类披萨，合着啤酒吞下便是一顿。心情好了来碗蛋炒饭算是回忆家乡。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/bear.jpg" alt="image" /></p>

<p>泰国食物是吃不得的，酸里透甜，甜里泛辣，还得捏着米饭沾黄了吧唧的咖喱吃，哀民生之多艰。</p>

<p>岛上的住所也算别致，但仅作远观不可亵玩，里面陈设说得上简谱，想来都是一船船拉来的木板慢慢堆砌出来，也不能苛求多少了。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/hotel02.JPG" alt="image" /></p>

<h4>2.2 西方文化的世界</h4>

<p>晚上漫步沙滩，各处的酒吧都是众人的狂欢，独少见亚裔人的身影。灯光几处不甚亮堂，有玩火的艺人助兴照耀。伴着大功率的歌曲舞动。中间围绕的竟是个甩大绳，也玩得熠熠生辉，轮流上阵不亦乐乎。灯火稍暗处也有几人自顾自high，或站桌上或立沙滩摇头抖肩。回顾自己，斜卧最外一层无人光顾的躺椅上，看似逍遥却羡慕不已，想要融入但不得其法。精神语言上无一不束手束脚，一片白色的世界，却不在热寂之后，置身其中满不是滋味。</p>

<h2>3.0 潜水</h2>

<h4>3.1 PADI与SSI</h4>

<p>一般印象中背着个氧气瓶下水的潜水叫<strong>水肺潜水</strong>，即<strong>SCUBA DIVING</strong>，是“Self-Contained Underwater Breathing Apparatus”各单词的首字母拼起来的，大略意思就是可以自己控制呼吸的潜水方式。</p>

<p>本着下水有风险，游玩需谨慎的出发点，一个未经培训认证的人一般是不允许潜水的。潜水资格的获取要一步步来，从最开始的<strong>OPEN WATER DIVER</strong>即<strong>OW</strong>,慢慢往后有很长的路要走。一个小白若想初步感受水下世界的魅力，第一步要做的是取得最基本的<strong>OW</strong>认证。</p>

<p>世界上有资格进行培训的机构有不少，最出名的要数<strong>PADI</strong>，其次<strong>SSI</strong>也不错。因为休闲潜水的教学标准是一个国际组织制定的，各家机构也都是按照此一规章进行培训，所以有啥差别我现在也看不出来，选择<strong>SSI</strong>的原因只是因为比<strong>PADI</strong>便宜几百块钱罢了。</p>

<h4>3.2 报名，理论与基本技巧学习</h4>

<p>18日下午刚到便去潜水店报名了，SSI最基本的课程，包含理论考试，泳池学习与公开水域学习。最快两天半的课程吧（最后我们用了三天半搞定&hellip;）。</p>

<p>去之前其实也并没有多了解这些理论，也都是随着一步步学习慢慢清晰明了的。一路学来，切身感受最明显的便是这些教学标准的制定相当科学与实用。</p>

<p>之前习惯了为考试而学习的思路，所学与所用之间不觉会有什么共通之处。而在这次学习中，不论从理论的掌握还是基本技巧的教授，都是依着水下生存与活动展开的，可以说直到最后拿到潜水证后，确实很有信心在水下独立活动，并应对一些基本的突发情况。这种喜悦是成功的满足与发现知识可以如此贴切实用欣喜掺杂一起的，尤其兴奋。对比之前驾校的学车，真是天上地下的差别。</p>

<p>头两天是在浅水区域学习基本的潜水与突发情况处理技巧。比如保持在水中的中性浮力通过调整呼吸来达到上浮下潜的目的，或者紧急解除负重上浮及与他人共享气源等等。所有动作都需要教练验证通过方可进行下一节的学习，也算有惊无险了。</p>

<p>倒是第二天的游泳考试带来了不小麻烦。头晚下了场典型的热带暴雨，早上起来后天还是阴阴沉沉，风也不小。待到岸边的时候，浪冲地我们几乎无法入水，便要在这种情况下完成200的游泳。我尚能应付，但身边妹子去年刚刚学会游泳，前两周才在我逼迫下，在泳池里可以一次游一两个来回，着实为她捏了把汗。</p>

<p>后面的考试基本就成了我跟另一位助教妹子全程护航的游泳跋涉。看着小身影在浪涛中乍起乍伏，心想万一有个意外，不知道会不会被她爸一巴掌拍死在墙上，真是后怕不已。</p>

<p>游200m后的另一个考试项目是踩水10分钟，又是一项终极考验，SU尝试了两次都没坚持过两分钟便呛水不已，一度想要退出。教练便先单拉我出去练习水下技巧了，让助教妹子单独辅导踩水的技巧。</p>

<p>大概半个小时后好消息再度传来，这下明天便可以顺利出海，进行公开水域的练习了。</p>

<p>中午饱餐一顿，回来倒头便睡，一下午无话。</p>

<p>傍晚才又整装出门觅食，见有人租个小艇子划着玩，也心痒难耐试了一把，得出的结论是真鸡巴累啊，草。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/boat02.JPG" alt="image" /></p>

<h4>3.3 出海</h4>

<p>21号开始正式出海，后面三天都雷打不动6点出头起床，7点多出海潜水，贼鸡巴健康了。运气也不错，有时候半夜倾盆大雨雷声震天，但转头早上又是烈日当空，水波逐万里。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving01.JPG" alt="image" /></p>

<p>第一次外面下海说不紧张是骗你的，临行前还特意吃了片晕船药以防万一。</p>

<p>上船不久便起航出发去附近的小岛，路上教练又跟我们详细描述了这一天的练习项目，因为是第一次出海，所以会有些大块的时间来给我们水下随便游游，听着是蛮有意思的，但无奈还是弦绷着的，笑不大出来。</p>

<p>船泊岛旁，按教练的指导直接跨步入水，刹那间天地昏暗，唯独记得紧咬着呼吸装置。靠着充气的BC慢慢浮上水面后世界又重新出现在眼前，但更加清晰明了，前面的紧张情绪也被这一波带走。</p>

<p>重新下水后的世界又是一番新天地，起初在尚浅的地方做些基本的练习，待看我们渐渐熟悉后便开始带我们逐渐下潜，记得教练还在不远处见到一条小鲨鱼，不过2，3米的样子，比自己想象的要细些，并没有什么特殊的感觉，一条大鱼罢了。</p>

<p>看上去比较危险的反而是珊瑚和水胆，珊瑚一副人畜无害的样子，划过皮肤的感觉却不怎么妙。水胆自不必说，黑色的一个球，外面布满长过本身的尖刺，看上去就不好惹。</p>

<p>渐渐下潜，鱼的种类也多了起来，有些萌萌的胖头鱼，眼睛相当呆气，想起了家里的傻猫，还有环状条纹的水蛇在珊瑚丛中游弋，也亏教练能发现。当然最有趣的还要数小丑鱼，便是海底总动员那只橙色的小鱼，在教练嘴里却是一种比较危险的鱼类，还特意给我示范了了下，迅猛地向教练手心出击，还貌似听到了教练惊呼的声音，力道着实不小。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving03.JPG" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving02.JPG" alt="image" /></p>

<p>一般一上午下潜两次便告一段落，乘兴而归，恍若隔世。也不过潜了不到20米，对大洋来说皮毛而已，果然是越了解越是敬畏。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving06.JPG" alt="image" /></p>

<h4>3.4 领证</h4>

<p>22号中午结束了最后一次潜水课程，幸运的从教练手里拿到了<strong>OW</strong>的潜水资格，一步步考过来很有成就感，一番独特的记忆。</p>

<p>这几天我们都住在岛的中央，之前想着体验下海边的五星级酒店待遇，便在岛的北部定了一晚星级的体验下，于是下午收拾细软又乘船出发了。</p>

<p>事后看来那酒店不过如此，床大点软些而已，唯一印象深刻的是睡觉前看了中央台一个类似人物传记的节目，讲一个奇葩的小gay，爷们的外貌少女的内心，号称很少有人有资格可以嫖到他，一身鸡皮却挪不开眼睛，就着啤酒一直看完&hellip;</p>

<p>第二天早我们还很接地气的雇了个当地的潜导出海玩玩。</p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving04.png" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/road/tailand/diving05.JPG" alt="image" /></p>

<p>中午搭大船离开，结束了5天的PP岛旅程。</p>

<h2>4.0 普吉一日</h2>

<p>23号3，4点到的普吉，租了辆摩托车便又出行。想着好歹来一次试下泰国食物吧，结果还是又去别的地儿补了笼小笼包才算吃饱，已经对其彻底绝望。</p>

<p>第二天一早骑着个小摩托去最近的一个山顶观观景色，出发前揣着张地图信心满满，拐俩弯便彻底掉向，无奈掏出谷歌地图导起航来，娘的。</p>

<p>山不高，摩托可以一路骑到山顶，稍微上个塔楼便可以一览海湾景色，也算可以。停车那里有个小卖部，一位老婆婆看着。商品稀稀疏疏，哧哧剌剌的电视看不大清画面，去到时还在屋后弓腰收拾空矿泉水瓶，半晌直不起腰，蹒跚着过来给我们取东西，唯旁边有只肥猫尚能作乐，不知晚间若何，儿女何在。匆匆下山罢了。</p>

<h2>5.0 归</h2>

<p>不在话下，所喜去也平安，归也平安。小渔村呆久了也是想念大城市的，围城也。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[回家过年记]]></title>
    <link href="http://sonnewilling.com/blog/2015/02/18/hui-jia-guo-nian-ji/"/>
    <updated>2015-02-18T16:47:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2015/02/18/hui-jia-guo-nian-ji</id>
    <content type="html"><![CDATA[<h2>车上</h2>

<p>今年的公历与旧历相差不小，深圳天热，裤子都快脱了才将将过年。吃了一年多米饭，很是想念馒头的手感，捏起来必定充盈丰富细泽光滑。</p>

<p>有了工作收入大不比从前，也可以土豪一把舒服的回趟老家。420一位的硬卧可以不是随便就能享受的了的。想着之前偶尔买不到票还要站回去，心下惴惴，特意找了位黄牛代办一切，朝中有人就是不一样。</p>

<p>小小方圆大千世界，套在一节火车皮上再适用不过，硬座尤然。或坐或站挤作一坨，互相客气着，眼神却不离座位。无关礼数教养，干站三个小时任谁都被打回原形。偶尔趁着正主离去，礼貌问下提臀便坐，受力的一刹那从尾椎爆发出来的快感一路烧到喉咙，大概跟喝小烧的顺序相反，如久违的情人相厮相守。</p>

<!--more-->


<p>随着飞机的普及平民化，火车上也渐渐寻不到靓妹的踪影，间或在卧铺车厢觅得一二已属万幸，至于长途的硬座却完全是老爷们儿的领地。利益自然要最大化，说不上什么尊老扶幼，竞争从上车前便开始。首先要考虑的是大件的行李，硬座车厢人多座儿少，行李架也尤其珍贵。上车稍晚头顶的天空全被占领，座位下也是密密麻麻，若还是个站票，抱着行李一路的辛苦double不在话下。若干挤惯长途的老油条还会先买通车站人员提前进站，比大部队早上车5，6分钟。这时候便可以好整以暇，将行李规整齐全，甚至占住列车接驳处的空间自造个铺位也是个常有的事情。</p>

<p>第一次见这种情况可能会嗤之以鼻，到了半夜，你看那桌子座位底下漏出来的人头，洗手间塞满的人群，不禁会向往那接驳处的一角，宁静祥和，宽敞明亮。回家的记忆起于想念，于此酿至最浓烈。</p>

<p>折腾一宿黎明下车，久违的北风沁心凌冽。亚热带的气候温热少嶙角，北去则多了些剽悍之气，如古语“燕赵多有慷慨悲歌之士”，一言以蔽之。</p>

<h2>家中</h2>

<p>出了车站大舅驱车而至，赶着早晨的饭点回到了家中，必然是一顿饺子以飨空腹。姥姥身体一年不如一年，今年回来看走路已很不方便。回想初离家时的健朗，未觉时光在自己身上走过，到底在老人身上看到了影子。</p>

<p>年夜饭菜样式无多花样，满桌的肉类，传闻中的青菜因为气不够了也没炒，星星绿色仅在拌猪耳的凉菜中找见。也亏如此，盘盘硬菜吃起来才够爽快。杯杯见底中扫去风尘，放开来把酒言欢。</p>

<p>今年春晚退居二线，微信红包抢占头条。公司群里搞起红包接龙大战，足球队群也抢个不亦乐乎，捧个手机离不开屏幕。偶然抬头看家里老人还是坐那看着电视，竟有些愧疚，迢迢千里赶回团聚，为了手头几十块的零零碎碎算是知道舍本逐末怎么写的。放下手机陪老人聊聊天过不了多大一会儿却又开始挂念群里发了多少红包，少抢了几份，又切身体验了一把鼠目寸光，就这素质了，着实难改。</p>

<p>年初一照常串门拜年，今年较往年少了很多，约莫此风气这几年中也会渐渐消失，自己尚觉有些遗憾，家中老人却不以为意，说自己在家看看电视就挺好，折腾来回太麻烦。</p>

<h2>酒席</h2>

<p>初一晚上大院里的以前的玩伴聚餐，有两位还领来了家属，传闻年终便要结婚。自己尚是幸福，却苦煞若干待字闺中的女同志。席中敬酒频频大约也都是朝着未来的新郎官，众人也乐得拾柴火焰高，赶着凑热闹。不多会便喝高一位，也算稍解恨意。</p>

<p>约莫到晚上十点才散席，仅有新郎官的娘子没喝酒开了辆车来，拉了几位女同志走，余下我等几位没人管顾。穷乡僻壤大年夜车是不指望打到，慢慢走回去呗。寒风瑟瑟阴雨丝丝，乘着酒意晃晃悠悠的倒也别有一番风味。不料走到一半同行的几位同志还觉腹中空，竟也找到一家小店，仅店主店娘两位，看着电视，快晚上12点的样子，守着个炉子。来盘饺子炒了个茄子也算麻利，便又坐回去看电视了。慢慢吃着解着酒气，想想今晚的行程荒唐却也有趣。临走时又来了一队人马，大概也是散了酒场打不到车。风雨中幸遇如此一酒家真真值得一书。</p>

<h2>送家堂</h2>

<p>这边有请送家堂的习俗。是把家里过世的长辈灵位在过年这几天供出来。年前请来，大年初二送走。送的时候磕头烧纸放鞭炮，供养用的食物晚上家里人吃掉，据说还有福气。</p>

<p>家堂之事由叔叔负责，去到家中最引人注意的便是堂兄养的萨摩，雪白蓬松，虽年年仅春节见一次，倒也熟悉我的气味，每次相别都抱住不放，呼吸相闻，一嘴膻味。</p>

<h2>尾声</h2>

<p>有聚有散，喝了几顿酒后便又到了打包滚蛋的时节。老家的节奏还是一样，表弟领来了女友，要不是属性相克今年便结起婚来，堂兄也各种制备齐全独缺新娘驾到。家里长辈也觉搞定下一辈的婚姻大事算是完成了自己的一桩任务，接下来关起门来过日子便是。</p>

<p>各自有福，不求甚多。来年再喝起来吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[去年今日]]></title>
    <link href="http://sonnewilling.com/blog/2015/01/06/qu-nian-jin-ri/"/>
    <updated>2015-01-06T20:38:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2015/01/06/qu-nian-jin-ri</id>
    <content type="html"><![CDATA[<p><img src="http://sonnewilling.com/images/life/app.png" alt="image" /></p>

<p>14年的最后一天单位要求写篇年终总结，把自己这三个月的工作摘录了下给交上去了，自己这边也再就懒地动笔。待元旦三天腐败回来也完全不再考虑下笔。但今天收到这张图却被狠狠捶到胸口，不吐不快。</p>

<!--more-->


<h2>嘿，初识</h2>

<p>毕业季的回忆算不上难忘，瓜熟蒂落自然分娩。但之前的校招却谈不上愉悦，贪欢三载，还想要找到份满意的工作，失意总是不可少的。却好在并没有太大的灰心，依旧寻寻觅觅。</p>

<p>发了很多Java开发岗，搞定家国企分部，印象中一个月4000+吧，说不上多满意但聊胜于无。却在这时收到XM的面试邀请，我也不记得啥时候投的简历。他们在招iOS开发，我一想，哎，我靠，这划算啊，还没摸过苹果电脑呢，得试试。</p>

<p>XM在海岸城租的写字楼，不大，几个房间而已，但靠着玻璃幕墙，竟也有些高大上的感觉。开头跟我聊的是LU哥，技术这块儿归他管。看大家都是实诚人，我也没好意思瞎扯，先说了自己没做过这方面的开发，但你们敢要的话我也敢做，待遇好谈。貌似最后四字是点睛之笔，之后的谈话都在愉快放松的气氛下完成了。</p>

<p>LU哥这块儿谈得差不多的时候关老板便出场了。穿着件蓝色文化衫，上面都是英文也没看懂，大方脸上胡渣刺着，清瘦结实。听着是北方口音，靠谱！技术上关老板也不懂，聊下三观而已，反正就捡着老板爱听的吹呗，这事儿便成了。</p>

<h2>蜜月</h2>

<p>四月一号入职，当时还觉得这日子不是很好，总得来个黄道吉日吧，也没好意思说。来的第一个早上好好把Mac Mini摸了把，正过来反过去的摸，捧起来这瞅瞅那瞧瞧，十分钟没放手，新鲜是其次，开关键在哪啊，日。</p>

<p>后来还是继续摸索呗，也没人带，LU哥从精神上给我支持大方向上把把关，毕竟他也没做过iOS的开发。</p>

<p>收获很大，之前在实验室做项目的时候，有很多学长在，脏活累活他们顶着，出了问题及时反馈坐等解答，衣来张口饭来伸手。乍一下自己单干是有点虚，但时间久了便慢慢有了些底，反正问题在那是要解决的，慢慢磨总归还是会出现门路。</p>

<p>就这样一路折腾，中间还整个项目重构了一把，9，10月份的时候发了人生中第一个App到App Store。说没有洋洋得意那是骗别人的，分分钟人生赢家的美梦做起来，做程序员真好。</p>

<p>接下来又搞了个Pad版，因为有了前面的经验，做得也更加仔细了，各文件夹的命名照着规范来，每个VC的名字斟酌再斟酌，变量名写得长且美，心中总有个信念，这个App打从我这儿开始便没个头儿，代代相传恒久远，就差没取名叫<code>始App</code>了。</p>

<p>Pad版上线后一度冲到前100，每天查看下统计数据心里都还美美的。</p>

<h2>分手</h2>

<p>奈何蜜月总是短暂的，14年春节回来觉得个人能力有限，不能将手头的东西再提升一个档次，便选择了离开，那时倒没有多大的伤怀，更多的有种武装到位继续前行的自信。也没有想过这段“初恋”的结晶会走向何处，现在收到的这份东西令我发怔，说不上后悔，只是再回头看去好似一场灯旋火舞的狂欢，沉醉不知归路，日升月落间却扫来了一地的残羹冷炙，如何不叫人叹惋。</p>

<p>现在这家公司月末也要搬去新的地点，算上开头离去的公司，按农历年算的话今年一共换了五个工作地点&hellip;离开XM后先去的一家做飞镖机游戏的公司，中间也搬了一次，10月份的时候又换到现在这家公司。也许不单是我的境遇如此，大概现在的软件行业都是如此。快速的行业迭代，公司的生命潜质被发掘到最大，迅速的成长或烟花般陨落，不疯魔不成活。</p>

<h2>第二任</h2>

<p>后面经历的两家公司都令我成长很大。走出XM后的第一家公司虽然以iOS开发招进来的，但缺个后台做聊天服务器的，便顶了上去。也没用现成的开源协议啥的，就直接裸写Socket，一个字符串过去，关键信息逗号隔开，还真是方便省事。中间先是在Mac下开发，后来又迁移到Win下面，工具库也使用了很多，比较常用的是<code>GLib</code>和<code>Libevent</code>。因为之前一直在搞Java开发，C语言相关的知识一直在爪哇国放着，算是重头学起吧。记得光编译这俩工具包加起来都花了我一周的时间。后来迁移到Win下面，整个工程的重新编译又搞了一周。现在看来其实都是一些细节没有把握住，反复的尝试做无用功，一点点给试出来的。可惜当时我们团队也都没有搞这方面的，基本都是Java，OC，PHP高级语言。想起之前有人说过同样年限的C++程序员要比Java的整体高一些，看来不是无稽之谈。</p>

<p>确实，现在高级语言的特性让编程变得简单上手，成熟的IDE也让语言的编译一键完成。不是说这样不好，自动挡开起来肯定比手动挡方便，但相信开手动挡的总归要比自动挡的对汽车的熟悉程度要高些，出了问题也好排查。</p>

<p>因此现在看来，在第二家公司收获最大的便在于此。在学校用过一段时间Java，出来的第一份工作用的也是OC。对底层编译，网络通信，操作系统什么的只有简单书本上的记忆，并没有切身的操作体会。感谢那家公司有如此大的耐心让我慢慢折腾这些东西，边学边做，很宝贵的一段经历，可以说是拿着正式员工的工资做着大学作业&hellip;不知道如果Fei哥看到了会作何感想，哈哈。</p>

<h2>现任</h2>

<p>中间因为几个原因忍痛跟前任分了手，来到现在这家公司。很强大的团队，基本都是些大厂子里出来的高手，算是开了眼界。刚开始是有点不适应的，一直在小作坊作业，乍加入一个成熟的技术团队，会发现自己很多地方都相当业余。最先暴漏出来的毛病是团队作业不熟练，这边产品，设计，测试一条龙，每一步都有人把关。第一次经历App更新时看到四五个人发邮件确认自己负责的部分是否OK，很帅气。其次有了人review自己的代码，刚开始经常会返厂重改，次数多了后渐渐在代码规范这块儿有了自己的体会，知道自己后面有人会检查自己的代码也觉得很安心。另外也有机会查看别人的代码，跟我同组的两个哥儿们技术都比较屌，他们提交的代码都会经常看一下， 看下高手的代码是咋样写的，自己有哪些地方需要学习。开头看的时候云里雾里，一方面是整体编码思维上没有跟上，另一方面是不经常看别人的代码，不知从何入手。看多后便可以慢慢挖东西出来。有些固定的代码块儿可以利用，有些多线程的思路也可以参考，这方面进步很大。</p>

<h2>The Future</h2>

<p>过年回来毕业可以算是两年了，身边的有些同学还在出国深造，也有些组建了自己的小家庭。成熟的社会体系给人提供了更多的选择，庆幸可以在一个比较大的都市里生活，也希望以后有机会能体验其他类型的社会。</p>

<p>读万卷书行万里路，好好学习，天天向上。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[台湾流水账]]></title>
    <link href="http://sonnewilling.com/blog/2014/10/08/tai-wan-liu-shui-zhang/"/>
    <updated>2014-10-08T22:35:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/10/08/tai-wan-liu-shui-zhang</id>
    <content type="html"><![CDATA[<p>十一出游台湾是一天无聊在街上闲逛的时候敲定的，大概还是在三四月份的时候。第一次办证总免不了有些磕磕碰碰，但好歹也算有惊无险地搞定了。七月初买了去程的机票，待所有证件办齐八月末的时候才开始大张旗鼓的计划起行程，订住宿买回程机票不在话下。六天出游回来，想想还是蛮顺利的，天公作美。</p>

<!--more-->


<h3>Day1-台北</h3>

<h4>2014年10月1日</h4>

<p>没有啥计划，七月份冲着价格随手买了早上9点半香港飞的机票，待真到临走的几天发现九点多的航班实在是个坑。南山这边有个深圳湾口岸，在蛇口港可以直接坐船一个小时直达机场，只要100块而已，但悲剧的是口岸开放时间为早上六点，港口的船只针对10点以后的航班提供口对口的服务，之前的航班是别想了。所以只能趁着夜色五点多打车去皇岗口岸，折腾差不多三个小时，7，8点才到的机场，差点困死，算是吃一堑长一智了。</p>

<p>快11点踏上宝岛，说不上有多兴奋，主要是太困&hellip;日。机场有到市区的大巴，一人2，30而已，座位很是宽敞有点观光车的感觉。晃了一两个小时的样子到了台北车站，再从这里转地铁到住宿的地儿去。这里的地铁叫捷运，不知道怎么起的名字，根本改不了口。</p>

<p>住在西门町商业圈里面的一个民宿，蛮繁华的地儿，还有一条电影街，好多电影院，直接导致了我们当晚连续看了两场电影，哪里也没逛&hellip;</p>

<p>到了住宿的地儿补了会儿早上的觉才出门吃了个炸鸡啤酒，炸鸡还好，台湾啤酒一般，不是很好喝，有点涩。然后就开始看电影了&hellip;4，50一个人，跟深圳差不多，然后回来睡觉，不表。</p>

<h3>Day2-台北</h3>

<h4>2014年10月2日</h4>

<p>今天的正题是泡温泉，也是提前订的，不然到了再找的话可能会悲剧。</p>

<p>早上睡了个饱出门吃了永和大王便往中正纪念馆走。出了地铁看到纪念馆的主楼倒是真够霸气，不知道是不是为了补偿什么，据说喜欢开SUV的都是因为JJ小。</p>

<p>出了馆便直奔温泉往北投走，大概40分钟左右的车程。北投的建筑风格大都比较日式，泡温泉的地儿尤其如此。我们预订的是个叫加贺屋的馆，听说还比较有名。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/spa.jpg" alt="image" /></p>

<p>订的是个两人的单独房间，里面竟然有个可以喷水洗菊花的马桶，惊喜不已。温泉都没顾得上看，立马体验了下马桶的魅力。可以设置水流的强度跟角度&hellip;怎么说呢&hellip;实在很爽，刚开始会有些紧张，但找好角度调好强度放松身体你会欲罢不能的&hellip;温泉就那样了，一个半钟的时间，我进去泡了总共也就几分钟而已，自己热得不行家里掌柜却尤嫌不足，看她样子也是调好温度放松身体欲罢不能，女生去的话建议带张面膜，据说就完美了。</p>

<p>泡完出来顺便逛了下旁边的温泉博物馆还蛮漂亮的，隔壁是图书馆，相当棒，看攻略说全亚洲都排得上号。确实，环境清幽，还有小松鼠，配上几处地上升起的氤氲的地热气，调好座椅角度放松身体你会欲罢不能的&hellip;</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/library.jpg" alt="image" /></p>

<p>逛完北投时间还早便继续往北去了淡水，好像周董的母校就在旁边。但也没细找，随便沿海岸线走了下逛了逛夜市而已，算是来到台湾后第一次看到海景，倒也不错。晚上又去了师范大学的夜市，那里吃了个类似不放辣椒的麻辣烫，妹子的质量有些提升，毕竟在大学旁边还是不一样的。回到宿舍差不多10点多，又去了趟居酒屋喝了点小酒，其实就是逼格比较高的烧烤摊而已，体验一番罢了。</p>

<h3>Day3-台北-花莲</h3>

<h4>2014年10月3日</h4>

<p>上午退了房急急瞻仰了下国父便搭火车往花莲走。下了火车风还不小有些凉。上了点岁数的老板夫妻开车来接我们去了民宿，已经是下午5点多了。去到后发现他们女儿小老板娘还蛮漂亮的，再加上说话很嗲，住宿的本也算赚了回来。</p>

<p>街角有热闹的葱油饼摊子，不少人排队，试了下很一般，倒不如楼下三块一份的饼子。倒是这里有青岛啤酒，感觉比内地的要爽口一些，不知道是不是水的原因。买三瓶还打折自然不能放过。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/congyoubing.jpg" alt="image" /></p>

<p>吃完葱油饼便沿着路向东走，继而又发现了一段海岸线，不知道是不是傍晚的原因，风相当的大，大有把人吹跑的气势。但我也毫不示弱，迎风怒尿了一泡，还是三丈的年纪。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/niao.jpg" alt="image" /></p>

<p>回来将将天黑，发现了一家按脚的馆子&hellip;价钱倒还可以便又腐败了一把，通透。出来又是一顿炸鸡烧烤啤酒，微醺着逛了回去。</p>

<h3>Day4-花莲-垦丁</h3>

<h4>2014年10月4日</h4>

<p>早上拼车从花莲到垦丁，算是一日游。沿途的景色很棒，见到了太平洋的全貌虽然没有小时候第一眼见大海时候的震撼但看着无垠的大洋心里还是感觉到一阵畅快的。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/hualian.jpg" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/road/taiwan/hualian2.jpg" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/road/taiwan/hualian3.jpg" alt="image" /></p>

<p>大概7点多到的民宿，住的地方出了点小差错，不过老板娘倒很是热情，退了些钱给我们不说还答应明天借摩托车给我们骑，省了租车的费用外比一般的电动要爽得多。然后又拉我们去了垦丁大街，一起的还有两个上海的妹子。路上随便吹了下水。</p>

<p>垦丁大街倒相当一般，加大版的夜市而已，没有什么突出的东西，倒是在这里买了根自拍杆，算是最大的收获了，为后面的旅程增色不少，建议大家以后出去都带着这么一根，很值得。</p>

<p>随便找了家烧烤酒吧吃了喝了点小酒便结束了今天的行程回宿舍睡了，准备第二天的摩托车沿海游。</p>

<h3>Day5-垦丁-高雄</h3>

<h4>2014年10月5日</h4>

<p>起个大早吃完早餐便迫不及待的骑上了摩托车。虽然有些破旧但还是抵挡不住浪漫的情怀，很是兴奋。</p>

<p>单从玩的角度来说，今天算是这几天最爽的了。首先摩托车比一般游客租来的电动要快，而且还不怕没电，一路风驰电掣的超各种小电动好不痛快。另外走的基本都是沿海的公路，没啥车，宽阔明亮，偶尔还有盘山公路顺势而上登高远眺别有风味。</p>

<p>出门七八公里后到了个叫佳乐水的海滩，滩如其名，好水好滩好玩耍。游客不多，三三两两而已，而且大部分都是鬼佬在玩冲浪，像我们这种穿着衣服拍照的基本没有，真是有些丢人，看了下便匆匆走了，下次来台湾的话哪也不去了，就在这里待着天天爬起来冲浪晒太阳，妹的。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/jialeshui.jpg" alt="image" /></p>

<p>离开海滩稍微折回拐到旁边的岔路过个桥地势便逐渐往上，这时候摩托车的优势便体现了出来，油门一拉丝毫感受不出两人的分量多有影响。顺着坡一直往上，风也逐渐的加大，到一个上坡的终点的时候突然来了一阵妖风夹杂着沙石像是直接拍在了脸上一样，刹那间有些窒息，好在够重倒没有人仰马翻，就这样我们来到了下一个景点，风吹沙&hellip;想必起这个名字的人也是被这妖风拍地够呛才憋出了这个名字。</p>

<p>拍照留念后便赶紧下撤，站在崖边真有种要被吹进海里的感觉，马虎不得。下来的路上一阵开阔，加之刚刚的海风，人也清爽了很多。不自觉地速度便提了起来，好在道路笔直不见行人车辆，左手边就是辽阔的太平洋，竟有种恍若隔世的感觉，让我想起了肖申克救赎里面最后相聚的那个画面。</p>

<p>往前走不到半个小时来到一片草原，刚刚还飞沙走石的现在却是绿草油油清风拂面。这里的游客便多了起来，沿路上都有大巴车停着，一票游客聚在远处的一个崖边拍照，嫌人多也就没进去带上头盔直接走人了。</p>

<p>再往前的几处景点人也不少也无甚可说，跳过不表。</p>

<p>下午一两点的时候到了白沙湾，水很清澈大概是下图的程度。所以虽然出门的时候完全没有游泳的计划到了这里还是忍不住下了水。浪还不小，游泳啥的基本没戏，都是在边上逐浪的。租了个泳圈，随着一波一波的海浪玩得不亦乐乎。最后屁股都被沙子磨得生疼才恋恋不舍的爬了出来。租了个位置买了几罐啤酒开始晒太阳，差不多全身干爽后收拾离去。</p>

<p><img src="http://sonnewilling.com/images/road/taiwan/fanchuanshi.jpg" alt="image" /></p>

<p>因为4点半要回到民宿，所以从白沙湾出来后剩下的路程也没做过多停留，一路骑回算是过足了摩托车的瘾。</p>

<p>回来稍作停顿便上了开往高雄的巴士，中途还吃了个生的槟榔，初入口极涩极苦，差点要吐出来，把开头的几口浓汁吐出来后稍微好了一些，继而便是头晕目眩，大概是喝了两三瓶啤酒的感觉，所以妹子出门还是要切记不要瞎吃东西，搞不好就被人抱走了。我那颗槟榔是个路边的大妈给的，想来应该不会有啥危险&hellip;</p>

<p>天黑到的高雄，顺便买了第二天5点开去台中的车票。晚上就随便逛逛帮朋友买东西之类的不表。倒是在一条比较暗的街道上有个大院，里面不知供着哪位大仙，门口高挑着四五盏大红的灯笼，一些横幅对联之类也都是繁体字写着，别样的感觉从心头升起&hellip;</p>

<p>回到宿舍喝着啤酒看香港的占中。自己不用上课倒是轻松，消耗着商家的钱来谋求自己的政治福利，想想也是大学生能干出来的事情。本来还想坐等深夜清场直播，也没有坚持住，躺下睡去。</p>

<h3>Day6-高雄-台中</h3>

<h4>2014年10月6日</h4>

<p>上午起来11点多退了房将行李寄存在车站便往西子湾前行。出了地铁站直接打车到了国立中山大学，样式倒还古朴，比邻着大洋得天独厚。天气已不是很热，在一个大的庭院坐下买了杯奶茶还试了下现烤的奶酥厚片相当不错，加起来才7块而已，相比夜市里的七七八八不知道强多少倍。</p>

<p>吹风的空聊起了晚上几点能回来的问题，我印象中是11点多的飞机，我家掌柜问具体几点我也记不清便查了起来。行程单翻出来一看竟然是9：05起飞，瞬间有些斯巴达，到香港也才10点多为毛我能记成11点的飞机，我日。</p>

<p>一阵慌乱往外跑，那一段海岸线显得那么的漫长没有尽头，清幽的校园他妈连辆出租车也没有，大爷的，一身臭汗。</p>

<p>两点多赶到车站说要退掉5点的车票又问最早有几点的，幸运的是两点半正好有一班一样的，直接换了票便往月台奔。又不自觉地想为毛等火车的地方都叫月台。岔神的空家里掌柜也不知踪影，焦心等待后发现挎着个大包捧着一盒便当出现了&hellip;步履蹒跚一摇一晃让我想起了朱自清的背影，可惜全无心情。说台湾火车的便当闻名遐迩，抓住最后的机会要尝试一番，我也是醉了。</p>

<p>刚到月台列车便来了，这边的车靠站时间都很短，差不多上完客不怎么停留便直接开走，也算万幸赶上，毕竟去台中尚要两个半钟，再从车站去机场又要一个小时，要是坐5点的那趟班车那真是呜呼哀哉了。</p>

<p>台中的记忆便是在公车上一晃一晃，正值放学时段，听着学生们车上叽叽喳喳遥想当年。</p>

<p>机场不大，航班也少，看电子牌好像我们还是当晚的最后一班，可以想象如果我们九点多才到机场的话面对着一片乌起码黑心中会多么乱马奔腾。</p>

<p>半夜三点多才回到家中，台湾之行便在这紧密充实中度过了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[秋思]]></title>
    <link href="http://sonnewilling.com/blog/2014/09/23/qiu-si/"/>
    <updated>2014-09-23T15:16:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/09/23/qiu-si</id>
    <content type="html"><![CDATA[<blockquote><p>我说那儿黑，他说他恨日光。我说那儿很孤独，他说跟聪明人说话是滥用他的心智。我说他疯了，他说上帝留他不必做精神健全的人（上帝一定会的）。</p></blockquote>

<p>海鸥过境，雨很是磅礴地下了几天，本以为走后便又会迎来高阳烈日，出乎意料的，风中带有了丝丝凉意。</p>

<p>就像一个力竭的汉子，最后的时光里每经受多一次打击都越发难以恢复之前的意气。</p>

<p>在深圳这种南方城市很难感受落寞的秋意，不像北方的寒地，叶子吸收了暑气而发黄飘落，风不请自来，很有股迫不及待的劲儿要补回夏日的缺席。而在回归线这里，点点的秋意好似害羞的姑娘，生怕被你发现，偷偷掩在夏日的身后，趁着衣角的翻起一下跑向冬天的怀抱，如果不仔细观察你都不会意识到她的存在，颇有些倚门回首嗅青梅的神态。</p>

<!--more-->


<p>前几天早上起来去吃肠粉，凉风一阵，才惊觉她的到来，已经忘记上次干爽地走在路上是什么时候了，低头看了下脚上的拖鞋想起来有大半年没有感受过袜子的温暖不禁有小小的期待。也忍不住的想起了那句：</p>

<blockquote><p>快哉此风！</p></blockquote>

<p>暑气一吐而尽，好不爽快。</p>

<p>气候的变迁总能引起人的思想躁动，秋天尤甚，你看诗词中写秋日秋思的不计其数。所以我想大概所谓的情怀秋思都是需要大力气的，夏日抽身离去真空了我们一段气力而开动大脑。</p>

<p>由此看来，秋天实在是大自然给予我们的一份珍贵礼物。它解放了我们有些许定式或僵化的大脑，让大脑腾出空间去天马行空一下。</p>

<p>时光匆匆，回头看一下自己，好像做了很多又好像在原地踏步做流水线上的工作，并没有一粒粒闪亮的珍珠镶在我们这段时间走过的道路上。那看不饶人的岁月，是否有一丝恐慌袭上心头。</p>

<p>其实这种情形还是蛮正常的，我称它为思想的懒惰。这个思想的懒惰跟一般意义上的懒惰有些许不同。毕竟一些主动谋求的偷懒正是科技发展的源泉。而这里思想的懒惰好比肌肉重复动作多了后有它的肌肉记忆一样，是一种定式。这种定式相信对大多数人都不陌生，悄悄的，时间一久它就会找上我们却毫不察觉。待突然发现大概也是一种不知几世几年，不知有汉无论魏晋的桑田感概，甚至想咒骂一句“<em>索性再扔些破铜烂铁，让它烂成一沟绿酒</em>”。</p>

<p>所以这一阵秋意吹去了我们多少雾霾。但这只是大自然的偶然馈赠，若只求如此其它平凡的日子又如何度过。在我看来思想的灵动便是大脑中的一阵阵秋意，它带给我们的才是长久的喜悦与自信。</p>

<p>你让我展示一下这种灵动，我连开口的权力都没有，但我知道去哪里寻找。</p>

<p>看崔护的这首诗，</p>

<blockquote><p>去年今日此门中,人面桃花相映红</p>

<p>人面不知何处去,桃花依旧笑春风</p></blockquote>

<p>简单的桃花融合进他的思念，美好的景象跃然纸上，让人一遍遍回味。</p>

<p>我还很喜欢杜甫的《江南逢李龟年》中的那句，</p>

<blockquote><p>正是江南好风景，落花时节又逢君</p></blockquote>

<p>是一种长久的期待照进了现实，不忍卒读。</p>

<p>纵时隔千年，拾起来读上口后心中还是一阵跳动。穿过了历史的尘埃这诗句的力量丝毫未减，相反，却在厚厚的水泥城市中越发闪耀光芒。</p>

<p>再看一段季老的日记，</p>

<blockquote><p>1932年12月1日 过午看同志成中学赛足球和女子篮球。所谓看女子篮球者实在就是去看大腿。说真的，不然的话，谁还去看呢？</p>

<p>12月21日 看清华对附中女子篮球赛。说实话，看女人打篮球，其实不是去看篮球，是在看大腿。附中女同学大腿倍儿黑，只看半场而反。</p>

<p>1934年5月10日，晚上，有人请客，在合作社喝酒，一直喝到九点，我也喝了几杯。以后又到王红豆（即王岷源，红豆乃混蛋的对音）屋去闲聊，从运动扯起，一直扯到女人，女人的性器官，以及一切想象至辞，于是皆大欢喜，回屋睡觉。</p>

<p>今天（5月17日）看了一部小说，《石点头》，短篇的，描写的并不怎么秽亵，但不知为什么，总容易引起我的性欲。我今生没有别的希望，我只希望，能多日几个女人，（和）各地方的女人接触。</p></blockquote>

<p>跟之前推辞国学大师的季老相比，这一份日记里的形象着实更鼓舞人心。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[VC USB 串口通信]]></title>
    <link href="http://sonnewilling.com/blog/2014/08/11/vc-usb-chuan-kou-tong-xin/"/>
    <updated>2014-08-11T11:03:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/08/11/vc-usb-chuan-kou-tong-xin</id>
    <content type="html"><![CDATA[<h2>楔子</h2>

<p>前段时间搞完了聊天服务器后也没有很多事情，因为系统瓶颈停留在数据库读写层面，所以研究了一两周的NOSQL和Cache。NOSQL快是快但key-value型的数据结构实在太过简单，感觉真用起来并不是很方便，Cache倒相对来说可行一些，开多一个服务罢了，其实简单的逻辑自己也能实现。就这样纠结来纠结去的，发现其实现在的服务倒也完全够用，压力测试了下，能撑到1500的并发，想来刚上线估计也最多几百号人能同时聊天就不错了，所以就先研究至此，撑不住了再换，不要过早优化嘛。</p>

<!--more-->


<p>就这样决定先找别的事做做，恰好项目里有需要用到Flash的ANE技术来实现Flash与硬件通信，Flash自然不会写，但用VC进行串口通信打包成DLL给Flash调用这个还是可以研究下的。</p>

<p>ANE这里就不再细谈，大体上就是Flash中调用其它语言的一种技术，通过它可以实现一些Flash做不到的东西，比如说底层通信啥的。这里主要讲USB串口通信这一块儿。</p>

<p>串口通信翻了下书发现还是有很多标准的，而现行最流行的就是USB了，所以在网上关于此的资料还是很好找的。</p>

<p>这篇文章的内容主要由三个部分组成：</p>

<ol>
<li>串口连接的建立与简单阻塞通讯</li>
<li>通过API调用自动查询当前插入的USB设备并建立连接</li>
<li>区别于简单阻塞的通讯方式，如重叠IO与事件通知</li>
</ol>


<h2>一，建立连接与阻塞通讯</h2>

<p>在WIN下面，对于串口一类的硬件设备也是认定为文件的一种，所以也可以使用文件的方式来创建打开使用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">HANDLE</span> <span class="n">h_com</span> <span class="o">=</span> <span class="n">CreateFile</span><span class="p">((</span><span class="n">LPCWSTR</span><span class="p">)</span><span class="s">&quot;COM4&quot;</span><span class="p">,</span>   <span class="c1">//设备名</span>
</span><span class='line'>                  <span class="n">GENERIC_READ</span> <span class="o">||</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span> <span class="c1">//访问模式，可同时读写</span>
</span><span class='line'>                  <span class="mi">0</span><span class="p">,</span>                             <span class="c1">//共享模式，0表示不共享</span>
</span><span class='line'>                  <span class="nb">NULL</span><span class="p">,</span>                          <span class="c1">//安全性设置，一般使用NULL</span>
</span><span class='line'>                  <span class="n">OPEN_EXISTING</span><span class="p">,</span>                 <span class="c1">//该参数表示该设备必须存在否则创建失败，串口通讯需此设置</span>
</span><span class='line'>                  <span class="n">FILE_ATTRIBUTE_NORMAL</span>
</span><span class='line'>                  <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>首先初始化一个句柄<code>h_com</code>，让它指向所要打开设备的串口号，之后对该设备的所有操作均需通过该句柄来执行。</p>

<p>之后便是对此串口的一些基本设置，</p>

<h4><em>超时选项</em></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*设置串口的超时时间，均设为0，表示不使用超时限制*/</span>
</span><span class='line'><span class="n">COMMTIMEOUTS</span>  <span class="n">CommTimeouts</span><span class="p">;</span>
</span><span class='line'><span class="n">CommTimeouts</span><span class="p">.</span><span class="n">ReadIntervalTimeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">CommTimeouts</span><span class="p">.</span><span class="n">ReadTotalTimeoutMultiplier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">CommTimeouts</span><span class="p">.</span><span class="n">ReadTotalTimeoutConstant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">CommTimeouts</span><span class="p">.</span><span class="n">WriteTotalTimeoutMultiplier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">CommTimeouts</span><span class="p">.</span><span class="n">WriteTotalTimeoutConstant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">SetCommTimeouts</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CommTimeouts</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4><em>DCB参数配置</em></h4>

<p>因为DCB结构体中选项较多，故一般的配置方式是先通过<code>GetCommState</code>获取默认的DCB配置选项，再根据个人需求进行相应的修改。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/*将ANSI字符串转换为UNICODE字符串*/</span>
</span><span class='line'><span class="n">DWORD</span> <span class="n">dwNum</span> <span class="o">=</span> <span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_ACP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">szDCBparam</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="kt">wchar_t</span> <span class="o">*</span><span class="n">pwText</span> <span class="o">=</span> <span class="n">new</span> <span class="kt">wchar_t</span><span class="p">[</span><span class="n">dwNum</span><span class="p">];</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MultiByteToWideChar</span><span class="p">(</span><span class="n">CP_ACP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">szDCBparam</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">pwText</span><span class="p">,</span> <span class="n">dwNum</span><span class="p">))</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">bIsSuccess</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/*获取当前串口配置参数，并且构造自定义DCB参数*/</span>
</span><span class='line'><span class="n">bIsSuccess</span> <span class="o">=</span> <span class="n">GetCommState</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">BuildCommDCB</span><span class="p">(</span><span class="n">pwText</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="p">);</span>
</span><span class='line'><span class="cm">/*开启RTS flow控制*/</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">fRtsControl</span> <span class="o">=</span> <span class="n">RTS_CONTROL_ENABLE</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">fRtsControl</span> <span class="o">=</span> <span class="n">RTS_CONTROL_ENABLE</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">fBinary</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">fParity</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">ByteSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">Parity</span> <span class="o">=</span> <span class="n">ODDPARITY</span><span class="p">;</span>
</span><span class='line'><span class="n">dcb</span><span class="p">.</span><span class="n">StopBits</span> <span class="o">=</span> <span class="n">ONESTOPBIT</span><span class="p">;</span>
</span><span class='line'><span class="n">delete</span><span class="p">[]</span> <span class="n">pwText</span><span class="p">;</span>
</span><span class='line'><span class="n">SetCommState</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcb</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4><em>清空缓冲区</em></h4>

<p>对句柄进行了一系列操作，保险起见清空一下缓冲区。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">PurgeComm</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="n">PURGE_RXCLEAR</span> <span class="o">|</span> <span class="n">PURGE_TXCLEAR</span> <span class="o">|</span> <span class="n">PURGE_RXABORT</span> <span class="o">|</span> <span class="n">PURGE_TXABORT</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>如此，一个完整的串口句柄就构造完毕了。接下来是进行阻塞读的测试。</p>

<p>首先，我们可以使用<code>ClearCommError</code>这个方法获取当前读缓冲区里的数据大小，通过轮询的方式阻塞在这里，当缓冲区里有数据的时候我们再进行下一步的动作。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">get_dirty_len</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">DWORD</span> <span class="n">dwError</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">COMSTAT</span>  <span class="n">comstat</span><span class="p">;</span>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comstat</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">COMSTAT</span><span class="p">));</span>
</span><span class='line'>  <span class="n">UINT</span> <span class="n">BytesInQue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">ClearCommError</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwError</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comstat</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">BytesInQue</span> <span class="o">=</span> <span class="n">comstat</span><span class="p">.</span><span class="n">cbInQue</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当有数据到来便可以直接读取了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span><span class="p">(</span><span class="n">h_comm</span><span class="o">-&gt;</span><span class="n">is_working</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_dirty_len</span><span class="p">();</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">Sleep</span><span class="p">(</span><span class="n">SLEEP_TIME_INTERVAL</span><span class="p">);</span>
</span><span class='line'>      <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">recv</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">recv_len</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ReadFile</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="n">recv</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">recv_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>写与读类似</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">WriteFile</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="n">send</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>如上，一个简单的阻塞串口读写Demo便完成了。</p>

<h2>二，检测查询插入的USB设备信息</h2>

<p>因为是Flash直接对DLL调用进行设备连接，所以在C层面需要主动获取连接上的端口名建立连接，并将连接设备的信息返回给Flash调用者，故需要使用另一组工具完成任务。</p>

<p>在WIN下面有一组API可以完成此项功能：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SetUpAPI</span>
</span></code></pre></td></tr></table></div></figure>


<p>摸索<code>setupapi</code>的使用方法着实费了些力气，归结起来主要有两点</p>

<ol>
<li>英文阅读能力不足，MSDN上面说明的使用方法并没有深刻理解</li>
<li>整体知识把握不足，摸着石头过河，边试边蒙</li>
</ol>


<p>说到底还是要多看书，多读英文资料，大体结构把握了也知道从何下手，而且国内博客的资源大多抄来抄去，并没有多关注其所以然，代码贴来贴去，试着心烦远不如一点一点学起来得畅快。</p>

<p>言归正传，获取端口信息依旧要从句柄入手。</p>

<h4><em>1.借助API获取某一类设备的相关信息</em></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">HDEVINFO</span> <span class="n">hDevInfo</span> <span class="o">=</span> <span class="n">SetupDiGetClassDevsA</span><span class="p">(</span>
</span><span class='line'>      <span class="p">(</span><span class="n">LPGUID</span><span class="p">)</span><span class="o">&amp;</span><span class="n">GUID_DEVCLASS_PORTS</span><span class="p">,</span>
</span><span class='line'>      <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="n">DIGCF_PRESENT</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于<code>LPGUID</code>可以自己初始化，一般的普通设备系统也提供了宏定义，可以看到我这里使用了<code>GUID_DEVCLASS_PORTS</code>，指明需要获取的是<code>PORT</code>（COM端口）一类的设备信息。</p>

<h4><em>2.遍历连接设备，获取设备信息</em></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">char</span> <span class="n">szBuf</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
</span><span class='line'><span class="n">ZeroMemory</span><span class="p">(</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">SP_DEVINFO_DATA</span>   <span class="n">spDevInfoData</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SP_DEVINFO_DATA</span><span class="p">)</span> <span class="p">};</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">SetupDiEnumDeviceInfo</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spDevInfoData</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">));</span>
</span><span class='line'>  <span class="c1">//get ID</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">SetupDiGetDeviceInstanceId</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span>
</span><span class='line'>      <span class="o">&amp;</span><span class="n">spDevInfoData</span><span class="p">,</span> <span class="p">(</span><span class="n">PWSTR</span><span class="p">)</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">dest</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
</span><span class='line'>      <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
</span><span class='line'>      <span class="n">get_str</span><span class="p">(</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span><span class='line'>      <span class="n">get_id</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//get port</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">SetupDiGetDeviceRegistryProperty</span><span class="p">(</span><span class="n">hDevInfo</span><span class="p">,</span>
</span><span class='line'>      <span class="o">&amp;</span><span class="n">spDevInfoData</span><span class="p">,</span> <span class="n">SPDRP_FRIENDLYNAME</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="n">PBYTE</span><span class="p">)</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>      <span class="kt">char</span> <span class="n">dest</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
</span><span class='line'>      <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
</span><span class='line'>      <span class="n">get_str</span><span class="p">(</span><span class="n">szBuf</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
</span><span class='line'>      <span class="n">get_com</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">strcpy</span><span class="p">(</span><span class="n">coms</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">port</span><span class="p">);</span>
</span><span class='line'>  <span class="n">strcpy</span><span class="p">(</span><span class="n">vids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">id</span><span class="p">);</span>
</span><span class='line'>  <span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SetupDiEnumDeviceInfo</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个函数通过<code>Index</code>进行依次查找设备，若设备不存在则返回空终止遍历。</p>

<p>所以在最后我们可以通过初始化的句柄<code>hDevInfo</code>与遍历出来的设备信息<code>spDevInfoData</code>来查找我们想要获取的具体信息。</p>

<h2>三，重叠IO与事件通知</h2>

<h3>重叠IO</h3>

<p>重叠IO解决的是受IO性能的影响不能第一时间将预期的字节数全部读完必须时阻塞等待在<code>ReadFile</code>，待全部数据传输完毕才返回的问题。</p>

<p>简单说来便是假如我想读1000个字节的数据从串口设备，但当前传输速度只有100K/S，那岂不是要在<code>ReadFile</code>上阻塞10s才会返回？正常情况下是这样的，而重叠IO便是解决此一问题的正确方法。</p>

<p>它的大体思路是当主线程第一时间没有从<code>ReadFile</code>中读出预期的字节数后便立即返回<code>FALSE</code>，继续其它操作，另一方面会在后台单开一个线程执行读取操作，真正读取完毕后再返回主线程进行相应的逻辑处理。</p>

<p>下面看详细步骤：</p>

<h4><em>1.句柄设置为可重叠模式</em></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">HANDLE</span> <span class="n">h_com</span> <span class="o">=</span> <span class="n">CreateFileA</span><span class="p">(</span><span class="n">port</span><span class="p">,</span>
</span><span class='line'>      <span class="n">GENERIC_READ</span> <span class="o">|</span> <span class="n">GENERIC_WRITE</span><span class="p">,</span>
</span><span class='line'>      <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">NULL</span><span class="p">,</span>
</span><span class='line'>      <span class="n">OPEN_EXISTING</span><span class="p">,</span>
</span><span class='line'>      <span class="n">FILE_ATTRIBUTE_NORMAL</span> <span class="o">|</span> <span class="n">FILE_FLAG_OVERLAPPED</span><span class="cm">/*可重叠模式*/</span><span class="p">,</span>
</span><span class='line'>      <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4><em>2.使用可重叠模式进行读取</em></h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">DWORD</span> <span class="n">dwRes</span><span class="p">,</span> <span class="n">deRead</span><span class="p">;</span>
</span><span class='line'><span class="kt">char</span> <span class="n">cRecved</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
</span><span class='line'><span class="kt">int</span> <span class="n">BytesRead</span><span class="p">;</span>
</span><span class='line'><span class="n">OVERLAPPED</span> <span class="n">ol</span><span class="p">;</span>
</span><span class='line'><span class="n">ol</span><span class="p">.</span><span class="n">Offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">ol</span><span class="p">.</span><span class="n">OffsetHigh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="n">ol</span><span class="p">.</span><span class="n">hEvent</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">m_hComm</span><span class="p">,</span> <span class="n">cRecved</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BytesRead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ol</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">//success!</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">//无法第一时间读出数据</span>
</span><span class='line'>  <span class="n">dwRes</span> <span class="o">=</span> <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">ol</span><span class="p">.</span><span class="n">hEvent</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span><span class="c1">//设置5s超时</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dwRes</span> <span class="o">==</span> <span class="n">WAIT_OBJECT_0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">GetOverLappedResult</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//操作失败，使用GetLastError获取失败信息</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//操作成功，数据读出并存入cRecved数组中</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这便是一个可重叠IO的简单示例，可以看出当<code>ReadFile</code>返回<code>FALSE</code>后，我们通过<code>OVERLAPPED</code>结构体获取该操作的事件，并通过<code>WaitForSingleObject</code>来等待异步线程读操作的完成，然后通过<code>GetOverLappedResult</code>验证下最终读取的字节数，便算完成了。</p>

<h3>事件通知</h3>

<p>在一般的通信情景中，大多是有个线程一直等待消息的到来然后进行读取。在开篇的例子中我使用的是简单的睡眠轮询的方式，但在真实地应用场景中这样做显然是不符合实际的，于是便需要使用基于事件通知的方式。</p>

<p>既然是事件监听，那第一步需要做的便是添加事件监听事件，这一步是通过对句柄的设置来完成的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">SetCommMask</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="n">EV_RXCHAR</span> <span class="o">|</span> <span class="n">EV_TXEMPTY</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>EV_RXCHAR</code>表示一旦有字节到来便触发事件，<code>EV_TXEMPTY</code>表示缓冲区为空的时候触发事件。</p>

<p>接下来便是对此事件进行监听，并在事件到来时将数据读出：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">is_running</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">COMSTAT</span> <span class="n">ComStat</span><span class="p">;</span>
</span><span class='line'>  <span class="n">DWORD</span> <span class="n">dwRes</span><span class="p">,</span> <span class="n">dwMask</span><span class="p">;</span>
</span><span class='line'>  <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">myChar</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>  <span class="n">OVERLAPPED</span> <span class="n">ol</span><span class="p">;</span>
</span><span class='line'>  <span class="c1">//创建等待事件</span>
</span><span class='line'>  <span class="n">ol</span><span class="p">.</span><span class="n">hEvent</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="n">WaitCommEvent</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwMask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ol</span><span class="p">);</span>
</span><span class='line'>  <span class="c1">//对该事件进行等待</span>
</span><span class='line'>  <span class="n">dwRes</span> <span class="o">=</span> <span class="n">WaitForSingleObject</span><span class="p">(</span><span class="n">ol</span><span class="p">.</span><span class="n">hEvent</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">dwRes</span> <span class="o">==</span> <span class="n">WAIT_OBJECT_0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">dwMask</span> <span class="o">&amp;</span> <span class="n">EV_RXCHAR</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="n">rol</span><span class="p">.</span><span class="n">hEvent</span> <span class="o">=</span> <span class="n">CreateEvent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>          <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span><span class='line'>          <span class="n">ZeroMemory</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</span><span class='line'>          <span class="n">DWORD</span> <span class="n">dwRead</span><span class="p">;</span>
</span><span class='line'>          <span class="n">DWORD</span> <span class="n">dwErrors</span><span class="p">;</span>
</span><span class='line'>          <span class="n">COMSTAT</span> <span class="n">Rcs</span><span class="p">;</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>          <span class="c1">//获取缓冲区字节数量</span>
</span><span class='line'>          <span class="n">ClearCommError</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwErrors</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Rcs</span><span class="p">);</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">Rcs</span><span class="p">.</span><span class="n">cbInQue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="k">if</span> <span class="p">(</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="n">Rcs</span><span class="p">.</span><span class="n">cbInQue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dwRead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rol</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%d-%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Rcs</span><span class="p">.</span><span class="n">cbInQue</span><span class="p">,</span> <span class="n">dwRead</span><span class="p">,</span> <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>              <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">PurgeComm</span><span class="p">(</span><span class="n">h_com</span><span class="p">,</span> <span class="n">PURGE_RXCLEAR</span> <span class="o">|</span> <span class="n">PURGE_TXCLEAR</span> <span class="o">|</span> <span class="n">PURGE_RXABORT</span> <span class="o">|</span> <span class="n">PURGE_TXABORT</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上便是事件触发式读取的基本使用方法，需要注意的是，事件触发IO可以搭配重叠IO进行使用，以获得更好的效果。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[阿勒泰的角落]]></title>
    <link href="http://sonnewilling.com/blog/2014/08/02/a-le-tai-de-jiao-luo/"/>
    <updated>2014-08-02T15:05:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/08/02/a-le-tai-de-jiao-luo</id>
    <content type="html"><![CDATA[<p>论坛闲逛的时候无意间看见有人推荐李娟的书，清新平淡之类的赞美之词倒是没有在意，单看书名中的阿勒泰便足够将我吸引。</p>

<p>之前很喜欢一位讲新疆的作家是刘亮程，记得初中还是高中学过他得一篇课文叫《一个人的村庄》，明明很有记忆的事情，问了很多同学硬是一个有印象的都没有，奇怪了去。</p>

<p>那里面他写的寒冷尤其生动，说再旺的炉火也抽不走骨头根子里一年年积攒起来的寒意。几乎第一眼便喜欢上了。文章只是他散文集里的一篇，便找了整个册子从头看起，讲他的无聊孤独，地老天荒，看了进去抬头看周围竟有些回不过劲儿来，真好。</p>

<!--more-->


<p>再次拾起他的书是大二的暑假将近，心中躁动不安，很想出去走一遭。</p>

<p>西南已走过，目标便很自然地定在了西北。攻略可以舍去，人文地理还是要了解一下的。看了几本寡而无味的历史地理册子后就想起了刘。图书馆搜作者竟发现了之前没看过的《库车行》，按图索骥找来的还是一本配有彩图的书，欢喜不已。</p>

<p>书不大一晚卒读，又是一段新的旅程。就讲他在库车的见闻，缓慢却不乏规律。看到的好似尘土飞扬大饼烤馕，用心细视却如静静地流淌在暗河里的精灵，一个个生动亲切，便喜欢上了那里，心想一定要去看一看。</p>

<p>之前也看过对刘的评价，说当年他也着实掀起了一股浪潮，但很多大家对他的评论指责说他刻意将文字洗白，略去了很多现实的东西，只将读者想要的东西精雕细琢后呈现出来，又因为功力不凡，这种精雕并不是辞藻的堆砌反而是层层的剥茧，大白话一般的文章让人爱不释手。初看很不服气，但回过头来也确实有些嫌疑，书中是他，但感觉作为一个人，活得也有些虚幻与白净，很有些王小波《红拂夜奔》里的人物，但人家那是小说，毕竟说得过去。</p>

<p>而李娟的出现却打破了我的顾虑。两者给了我一样的体验，令我不禁往下想去新疆的辽阔戈壁的确赋予了生活在那里的人们不一样的视角，再以我们这些车水马龙的价值观来评价有失公允。</p>

<p>暑假到底去了西北一趟，带着单车坐火车到兰州，伴着拉面一路西行，在敦煌的莫高窟努力挖掘自己的艺术细胞但还是没有激起涟漪不如逃票进月牙泉来得爽快。一路大快朵颐灌着啤酒青海湖绕了半圈，又借着晨曦疾行200公里去睡一楼是卖棺材的小店。来到向往的阿勒泰喀纳斯身上的钱却只够买一张烤馕对着湖水细抿，日夜兼行跑来伊犁却并未看那大草原而是在网吧撸了一周，同行的伙伴将魔兽给练满了级。荒唐不经事顶着在嘉峪关染着的红毛逛满是哈维的汉人街，见身边一队队经过的维和部队感受GJ的强权。问我都有哪些收获这一去，八千里路尘与土。</p>

<p>当我坐在伊宁的一栋两层小楼中间露天台阶就着阳光看书时，心中确也有那么一丝丝的平静与火花，具体是什么说不上来，就感觉着很舒服，吃张馕晒晒太阳，本来刚睡醒的身子便又在这光芒中一点点的抽去力量，瞌睡犯将上来。</p>

<p>这次读李娟的书便将那种迷惑的情感一把火烧了上来，清晰明了浑身通透。</p>

<p>她讲自己在野外睡觉的经历，和衣便躺，至多把外套罩在头上遮挡阳光，因为不愿家里干活，可以这样一睡一天，临近傍晚才晃回去吃饭。有时候经过的羊群会把她吵醒，放牧的男子在旁边笑，她知道是那男子故意赶来吵醒的她，虽恼但并不挂怀，等羊群过去便继续会周公。自然亲切，跃然纸上，仿佛在看另一个世界的故事。却也有真实的一面，说她的恋爱，对象是一位开卡车的司机，初觉得那卡车又破又臭，晃来晃去开得极慢，爱上司机后感觉全然相反，瞧，仿佛又看见了邻家的大姑娘。说在结婚的舞会上无人陪她一个汉人女子跳舞，只能扯着一位四五岁的女童蹦蹦跳跳，待女童被母亲牵回家后看到自己特意穿来的裙子上面一个个的黑手印委屈得想哭，便也不自觉地为她哀伤。还有那位舞会上迷人的哈族少年，自顾弹琴，我们的女主角喝多了后也只能蹒跚回家无人理睬。</p>

<p>三毛也写过她的撒哈拉沙漠故事，多了几分轻巧，大家看到的是作为一个家庭主妇能在如此恶劣的环境中生活得有神有色的得意，也写她平淡的生活故事，读起来倒也不觉乏味，但看多了终归觉得那是别人的生活，作为一个看客又能如何？写她的丈夫，文字间带着满足与欣喜，一副美好的画卷值得欣赏，但正如伟大的剧本都是悲剧一样，唯缺陷与不足才会引发人们的喟叹思考冥想。</p>

<p>《我的阿勒泰》好似她的日记，看的过程中又像在看自己，一个与自己相仿的人生活在一个全然不同的文化世界中，有她的新奇与惊喜，也有她的孤独与无奈，相比于《一个人的村庄》那份冰封的孤独灵魂宛如一个已经久远的故事，李娟却是鲜活的火焰，跃动照耀在广袤的戈壁。这份大自然的静默与生命的跳动相得益彰，让人看了总会不自觉地动容。想去尝试但又清醒的认识到这种真实的辛苦化在笔尖不过了了几行，想来一般人终归还是差那么一些火候，便最终能坚持下来恐怕也给磨去了灵性泯然众矣。不禁感叹李娟的天才，能将生切活剥的羊肉做得滋滋入味以飨读者。个中滋味言不及万一，想要去看她的好，还是捧起书来自己读一遍吧。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[怀抱有时]]></title>
    <link href="http://sonnewilling.com/blog/2014/06/17/huai-bao-you-shi/"/>
    <updated>2014-06-17T15:49:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/06/17/huai-bao-you-shi</id>
    <content type="html"><![CDATA[<p>冬来夏往，就这么着毕业一年。毕业季的时候并没有多少感伤与兴奋，送了几届的人头轮到自己已经累感不爱。</p>

<p>随着艾莉娅踏上驶向布拉佛斯的商船冰与火又用这样一个充满希望的镜头结束了第四季的故事。我记得第三季结束的时候是龙母霸气的看着她的几条龙在天空飞翔，而在这一季的终结，又是她亲手将两条龙锁入地库，不知道它们命运几何。</p>

<p>艾莉娅跑到船头望向大洋深处的镜头美得动人，一片充满未知与希望的新世界，不禁感概生命的奇遇美好。想起开头时罗柏多么意气昂扬却终究抵不住一死，到底最珍贵的东西还是贱命一条，活下去来感知世界的精彩，便是一种自在充盈，无与伦比。</p>

<p>前一集中耶哥蕊特中箭临死，在琼恩怀里时喃喃那句“你什么都不懂”让人动容。连托蒙德都知道耶哥蕊特一直在喋喋不休的讲着要杀死琼恩是因为那至深的爱。生命的美妙再次得以体现，尤以死讲述的最具冲击力。</p>

<!--more-->


<p>规律化的作息容易使人懒惰，每晚从图书馆走出来就在计划着健身与看美剧的时间表，从未抬头看一眼周遭。后来在一个入冬寒假来临的晚上，照常从图书馆往家里走，因为假期与温度的关系竟也有些顾影自怜了起来，环顾一眼觉得有些寂寞。而当走出校门口时发现门口卖铁板烧的阿姨在跟旁边卖水果的小贩愉快的聊着天，说着近期的生意。有些羞愧自己直到现在才发现他们也是一个个鲜活的生命，有着自己的生活。</p>

<p>睁眼去看，会觉得整个世界都活了起来。到了小区门口，再看那坐在楼下长椅的保安，也开始好奇起了他是如何打发这一个个漫长的夜晚。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UNIX程序制作成WIN Server笔记]]></title>
    <link href="http://sonnewilling.com/blog/2014/06/14/unixcheng-xu-zhi-zuo-cheng-win-serverbi-ji/"/>
    <updated>2014-06-14T16:55:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/06/14/unixcheng-xu-zhi-zuo-cheng-win-serverbi-ji</id>
    <content type="html"><![CDATA[<h1>初</h1>

<p>四五月份折腾完聊天服务器后就放了下来开始做个公司的CMS，重拾PHP的感觉还不错。几年不见多了很多框架，随便挑一个用着也很是方便，感觉现在做应用层的开发真是越来越简单了。各种框架工具一应俱到，从UNIX脱离出来重新投入到一键式的开发环境中真有点说不出的幸福。</p>

<p>开始的时候以为编程的世界是个江湖，每个码农都应该朝着绝顶高手的目标不断努力，只有将自己的武功修炼到化境才能算得上功成名就，渐而渐的却发现自己所处的环境跟江湖有不少区别的。也许在自己不知道的层面上还是各种武林高手呼风唤雨，但就现在自己所处的位置却是一个战场无疑。自己的能力与各种框架工具相比就算提升了几倍也是显得那么微不足道。就好比之前写聊天程序时各种尝试，从多进程到多线程，从线程池到多路复用，就自己的能力而言性能是在可观的提升的，心里也有些小得意。直到后面用上了<code>Libevent</code>&hellip;回头看看自己的努力就像天边的浮云，看上去很美而已。</p>

<!--more-->


<p>现在的产品开发正朝着越来越高的层次迈进，对于程序员的素质要求也逐步的降低，很多时候小码农真的像战场上的士兵一样，每人一件标准式的兵器往前冲就是了，真正能主导战场走向的反而是居于幕后激昂指点的PM。</p>

<p><code>C++</code>11出了<code>shared_ptr</code>，苹果手里的<code>OC</code>搭配上<code>ARC</code>还尚嫌不足轰轰烈烈来了个<code>Swift</code>，<code>JS</code>不满足于前端的限制整了套<code>NODEJS</code>，<code>Python</code>的<code>Django</code>，<code>PHP</code>的<code>Codeigniter</code>，大学时所学的操作系统，指针，数据结构已经渐渐地离我们远去，能不能说这是一个最好的时代却也是一个最坏的时代呢？</p>

<h1>缘</h1>

<p>公司现在跑的测试服务器装的是WIN SERVER的系统，没道理为了一个小程序重装系统，所以就开始了踩坑遍地的跨平台旅程。</p>

<h1>足下</h1>

<p>首先需要的是确定使用什么工具进行WIN的编译。以为使用的是Mac做的第一次开发，借助了Eclipse+GCC，所以第一想法也是在WIN下使用这一套环境，进行Eclipse+MinGW相信也可以搞定。</p>

<p>在对GLib进行配置的时候还是相对顺利的，其实在自己心里设想的就是把用到的各种库填好相应的头引用，lib引用就足以使用了。只是后面的历程说明老是把事情往简单想早晚会吃大亏的。</p>

<p>在套Libevent就出现了很多问题，而且因为不知道是不是因为年代比较久远且与现在的潮流脱节，在Google上搜来搜去也就那么几篇文章，我在配的时候出现的<code>PROPC_MESSAGE ERROR</code>根本搜不出所以然来。</p>

<p>于是乎在折腾了N个日子后的一个悲观的整个人都不好了的下午，试想着不如直接用<code>Cygwin</code>算了，顶多从新把东西都编译一遍，但最起码这玩意儿咱做过一遍心里还有底。幸运的是下回来<code>Cygwin</code>刚试用了感觉一切良好的时候下班的时间到了。</p>

<p>回家吃饱饭在图书馆空调的沁脾下逐渐平息了青春的躁动决定还是另谋它法，<code>Cygwin</code>一条路走到黑搞不好被炒了鱿鱼都说不准。由此可见下班及时回家是多么的重要。</p>

<p>第二天回来重新来过开始用起<code>VS</code>来。WIN8配上VS，一切感觉都是那么的美好，阳光透过窗子洒在脚上提醒我到了穿拖鞋上班的季节。</p>

<p>GLib的配置依旧十分顺利，还是卡在了Libevent上。对Libevent的编译十分简单，使用VS自带的<code>nmake</code>可以很轻松的将Libevent的三个lib给编译出来。但在引用的过程中总会出现莫名其妙的错误。开始考虑的是x86与x64导致的问题，但分两种情况编译后问题依然存在。卡了快一天后在网上找到了一个配置好的Demo，运行竟然成功了。通过编译参数的详细对比发现在指定运行库的地方需要调整为<code>/MT</code>的模式，具体的原因参见这篇文章<a href="http://msdn.microsoft.com/zh-cn/library/2kzt1wy3.aspx">/MD、/MT、/LD(使用运行库)</a>，有点踏破铁鞋无觅处，得来全不费功夫的感觉。虽然配置好了但还是有点知其然不知其所以然。</p>

<p>接下来便是再接再厉将<code>mysql</code>的库搭好环境便算彻底搞定了。有时候总觉得事情老是在自己最放心的地方峰回路转，其实说白了还是自己的基本功不扎实，觉得简单并不一定了解到了方方面面，也可能自己并不知道其中的重点难点所在而又继续踩坑。对于<code>mysql</code>的配置这点感触尤其深刻。总觉得相当简单手到擒来，结果还是卡了半天，最后才发现自己选择的是x64的版本与工程版本不匹配，更换后终于拨云见日。</p>

<p>整体环境搭出来后才感觉轻松了不少，觉得这事儿终于算是有些眉目了。虽然WIN下面的socket是自己实现的，但还是跟UNIX的API保持一致的。只需在开始的时候来一句<code>WSAStartup</code>就万事大吉了。其它的便是一些接口的细节修改。在VS下面很多如<code>sprintf</code>，<code>fopen</code>的函数会报不安全的错误，建议修改成<code>sprintf_s</code>，<code>fopen_f</code>，懒得修改的话也可以直接对工程进行配置，忽略这个类型的警告。</p>

<p>最后的成功运行让我心中长出一口恶气，正好是周五的下午，收拾东西踢个靓球。</p>

<h1>峰回</h1>

<p>六月初的时候公司换了新的地点，大了不少不说离着也近感觉还是不错的。新地方上班的第一天便是赶紧在Mac上装个WIN8，之前编译的时候对着项目经理的13寸小电脑佝偻的一个多星期，说什么也不能再受罪了。</p>

<p>这年头来个双系统还是真是方便，纯鼠标操作点几下就搞定了。按完以后面对着WIN8高大上的界面不禁手痒，来几盘CS再方便不过。</p>

<p>这里上班有大食堂可以吃，不用像之前那样叫外卖了，不过之前也没怎么吃外卖，开始是炒了菜带来吃，嫌麻烦改成了面包火腿黄瓜鸡蛋，再后来还是嫌麻烦两片面包夹个鸡蛋足矣。新地方试了几天饭堂发现还是面包鸡蛋吃着爽快，唯一值得留恋的是中午吃饭可以遇到两位管理处的小妹妹，长得都还蛮不错的。</p>

<p>正当觉得要脱离苦海的时候boss要求要把exe做成服务，这样开机可以直接启动更方便。没啥好说的，继续耕耘呗。</p>

<p>开始的时候没什么思路，在网上简单的搜索了下发现有个<code>sc</code>的命令可以直接将exe制作成服务，很是开心。结果制作出来的服务跟不启动不了，再仔细一搜发现关于服务的工程需要调用特定的WIN API才行，觉得心里有点毛，不会又要一阵折腾吧。</p>

<p>在VS下面发现可以直接新建c#的服务工程，但又不能直接用c的代码，想着可以将做的项目做成lib再在里面调用，觉得十分可行。为了验证自己这个想法的可行性，背起书包回家吃饭。</p>

<p>第二天再来的时候果然觉得这个方案不是很靠谱，因为不熟悉WIN API而想方设法绕过去看上去很简单，搞不好又是一坨屎出来。静下来琢磨下过程，直接用c来调用的话应该也不会很难，就当学习呗。</p>

<p>大体的了解了下思路，发现没有自己想象的难，大体就是开始的时候初始化一个叫<code>分配表</code>的结构体，在这个结构体可以定义服务的名字和主调用程序，然后调用一个叫dispatch的函数，大体意思是这个dispatch会把当前进程转换为分配表的进程，然后再通过分配表启动一个新的线程，再用这个线程调用我们的主程序。在这个主程序中我们还需要对当前服务的状态进行不同程度的修改，然后把自己写好的程序放进去就行了。另外还需要写一个<code>Handler</code>来接收这个服务的各种返回状态。</p>

<p>需要注意的是启动的服务无法打印信息，需要搭配日志来使用。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[基于C的Socket聊天服务器]]></title>
    <link href="http://sonnewilling.com/blog/2014/05/05/ji-yu-cshi-de-socketliao-tian-fu-wu-qi/"/>
    <updated>2014-05-05T16:26:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/05/05/ji-yu-cshi-de-socketliao-tian-fu-wu-qi</id>
    <content type="html"><![CDATA[<p>前段时间使用C借助libevent，glib实现了一个简单的可以单聊，群聊的服务器，今天因为需求有些改动所以又翻出来改了一下。果然一日不见如隔三秋，虽说是自己写的东西，但基本上已经忘得七七八八了。觉得有必要在这里记录一下，省得以后又悲剧。</p>

<h2>一，工具类</h2>

<h3>1.libunp.a</h3>

<p>用到的第一个库便是它，因为它是《UNIX网络编程》的示例代码的工具库&hellip;开头写的测试程序基本都是照着示例代码改来改去，自然也是用的一样的函数来实现。觉得对于一般的读写和各种包裹函数都是很有用的。具体的不用细说，还是认真翻书来得实在。</p>

<h3>2.GLib</h3>

<h4>GHashTable</h4>

<p>这里基本的数据结构如哈希表之类的使用了GLib来做主角，另外它的GString也很好用，可以很方便的初始化与格式化字符串，个人感觉比C风格的字符串要好用一些。</p>

<p>GLib哈希表支持各种不同的结构，如果觉得<code>int</code>,<code>string</code>不够用可以直接使用指针，对于我来说已经相当足够。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GHashTable</span> <span class="o">*</span><span class="n">user_to_bev_map</span> <span class="o">=</span> <span class="n">g_hash_table_new</span><span class="p">(</span><span class="n">g_direct_hash</span><span class="p">,</span><span class="n">g_direct_equal</span><span class="p">);</span>
</span><span class='line'><span class="n">g_hash_table_insert</span><span class="p">(</span><span class="n">user_to_bev_map</span><span class="p">,</span> <span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">u_id</span><span class="p">),</span> <span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">bev</span><span class="p">));</span>
</span><span class='line'><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span> <span class="o">=</span> <span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">user_to_bev_map</span><span class="p">,</span><span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">to_id</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>g_direct_hash</code>,<code>g_direct_equal</code>代表初始化的类型，详细的介绍如下:</p>

<blockquote><p>Hash values returned by hash_func are used to determine where keys are stored within the GHashTable data structure.</p>

<p>The <code>g_direct_hash()</code>, <code>g_int_hash()</code>, <code>g_int64_hash()</code>, <code>g_double_hash()</code> and <code>g_str_hash()</code> functions are provided for some common types of keys.</p>

<p>If hash_func is NULL, g_direct_hash() is used.</p></blockquote>

<!-- more -->


<h4>GString</h4>

<p>相比于C风格的字符串需要定长初始化，拼接赋值之类的，GString提供的字符串要人性化很多，还内置了长度的属性，可以很方便的调用。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="n">g_string_sized_new</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_printf</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="s">&quot;INSERT INTO table (id, type) VALUES (%s, %s);&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_erase</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sql</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_free</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>还可以很方便的重复使用，但不要忘记最后的释放，关于释放函数的第二个参数是这样说明的：</p>

<blockquote><p>If free_segment is TRUE it also frees the character data. If it&rsquo;s FALSE, the caller gains ownership of the buffer and must free it after use with g_free().</p></blockquote>

<p>还有个常用的函数是<code>g_strsplit</code>，可以对字符进行分割,第三个参数表明需要分出几个来，0的话则一直切分到最后。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">gchar</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="n">g_strsplit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">dispatch_request</span><span class="p">(</span><span class="n">source_id</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span><span class='line'><span class="n">g_strfreev</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>当然，关于GLib还有很多有用的东西，用Dash下个文档慢慢翻着看一遍相信会很有收获的。</p>

<h3>3.Mysql</h3>

<p>有服务的地方就有数据库，对于这种简易的小服务，Mysql是必不可少的。</p>

<p>针对Mysql封了三个简单的函数方便调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">MYSQL</span> <span class="o">*</span><span class="nf">db_connect</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">user_name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pwd</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">table_name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">MYSQL</span> <span class="o">*</span><span class="n">conn_ptr</span><span class="p">;</span>
</span><span class='line'>  <span class="n">conn_ptr</span> <span class="o">=</span> <span class="n">mysql_init</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conn_ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;mysql_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">conn_ptr</span> <span class="o">=</span> <span class="n">mysql_real_connect</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">pwd</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">mysql_set_character_set</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">,</span><span class="s">&quot;utf8&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">conn_ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">conn_ptr</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">MYSQL_RES</span> <span class="o">*</span><span class="nf">db_query</span><span class="p">(</span><span class="n">MYSQL</span> <span class="o">*</span><span class="n">conn_ptr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">mysql_query</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">,</span> <span class="n">sql</span><span class="p">);</span> <span class="c1">//查询语句</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mysql_error</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">));</span>
</span><span class='line'>      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res_ptr</span> <span class="o">=</span> <span class="n">mysql_store_result</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">);</span>              <span class="c1">//取出结果集</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;affected %lu rows</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mysql_affected_rows</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">));</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">res_ptr</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>返回的<code>res_ptr</code>需要手动释放：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">mysql_free_result</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>还有一个关闭函数：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">db_close</span><span class="p">(</span><span class="n">MYSQL</span> <span class="o">*</span><span class="n">connfd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">mysql_close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样，在服务器起来时建立数据库的连接存为全局变量，每次直接拿来用就好了，下面是一个比较典型的使用场景：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">GString</span> <span class="o">*</span><span class="n">sql</span> <span class="o">=</span> <span class="n">g_string_sized_new</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_printf</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="s">&quot;INSERT INTO table (id, type) VALUES (%s, %s);&quot;</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">type</span><span class="p">);</span>
</span><span class='line'><span class="n">db_query</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">,</span> <span class="n">sql</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_erase</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sql</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_printf</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="s">&quot;SELECT uid FROM table WHERE pid = %s&quot;</span><span class="p">,</span><span class="n">target_id</span><span class="p">);</span>
</span><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;find users sql2:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sql</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'><span class="n">MYSQL_RES</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">db_query</span><span class="p">(</span><span class="n">conn_ptr</span><span class="p">,</span> <span class="n">sql</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'><span class="n">MYSQL_ROW</span> <span class="n">sqlrow</span><span class="p">;</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">while</span><span class="p">((</span><span class="n">sqlrow</span> <span class="o">=</span> <span class="n">mysql_fetch_row</span><span class="p">(</span><span class="n">res</span><span class="p">)))</span>  <span class="p">{</span>
</span><span class='line'>      <span class="kt">long</span> <span class="n">to_id</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">sqlrow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="n">g_hash_table_contains</span><span class="p">(</span><span class="n">user_to_bev_map</span><span class="p">,</span><span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">to_id</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">sqlrow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">source_id</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span> <span class="o">=</span> <span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">user_to_bev_map</span><span class="p">,</span><span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">to_id</span><span class="p">));</span>
</span><span class='line'>          <span class="n">evbuffer_add_printf</span> <span class="p">((</span><span class="k">struct</span> <span class="n">evbuffer</span> <span class="o">*</span><span class="p">)</span><span class="n">bufferevent_get_output</span><span class="p">(</span><span class="n">bev</span><span class="p">),</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">send_msg</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">mysql_free_result</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_free</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="n">g_string_free</span><span class="p">(</span><span class="n">send_msg</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>4.libevent</h3>

<h4>介绍</h4>

<p>libevent是个好东西，有了它一般的数量级的连接都不在话下了。关于这种大数量的连接是有专门的话题来讨论的-<a href="http://www.kegel.com/c10k.html">C10K</a>。</p>

<p>最开始尝试了多进程多线程，select阻塞之类的方法，最后才找到这里来，也算是按着故事的发展逻辑走了一遍符合剧情尿性吧&hellip;<a href="http://daniel.haxx.se/docs/poll-vs-select.html">这篇文章</a>写得不错，比较有指导性。</p>

<p>关于libevent上手说不上难，狠下心来多读几遍它的<a href="http://www.wangafu.net/~nickm/libevent-book/">Fast portable non-blocking network programming with Libevent</a>弄明白了个大概还是不成问题的。</p>

<p>它的优点是跨平台，可以针对不同的平台的阻塞实现相同的功能。对于我们来说只需要关心event这个东西就好了，至于是UNIX的select，Linux的epoll还是BSD的kqueue那是libevent的事情，它会在底层帮我们选择<a href="http://monkey.org/~provos/libevent/doxygen-2.0.1/">libevent Documentation</a>。</p>

<h4>原理</h4>

<p>原始的socket的连接是我们建立了连接，获得一个套接字，然后对这个套接字进行多路复用的读写。</p>

<p>而现在我们可以使用libevent提供的event将这个套接字包裹起来，针对这个event编写它特定的读写函数。因为libevent是事件驱动的，所以当读写缓冲区达到特定条件时便会自动调用我们事先定义好的函数进行逻辑处理。大大简化了编码人员的工作量，可以让我们将更多的精力集中到逻辑代码的编写上面来（恰恰是最无聊的部分&hellip;），所以这么看来，也算是对程序员傻瓜化了一下吧。</p>

<p>因为对event的读写涉及到缓冲区的东西，需要我们去按字节的读出来，这里libevent也很贴心的又帮我们简化了一下工作。除了event外还提供了<a href="http://www.wangafu.net/~nickm/libevent-book/Ref6_bufferevent.html">bufferevent</a>，看名字便知道这是专门针对读写字符准备的。这是网站上对它的介绍：</p>

<blockquote><p>Most of the time, an application wants to perform some amount of data buffering in addition to just responding to events.</p>

<p>When we want to write data, for example, the usual pattern runs something like:</p>

<ul>
<li><p>Decide that we want to write some data to a connection;</p></li>
<li><p>Put that data in a buffer.Wait for the connection to become writable;</p></li>
<li><p>Write as much of the data as we can;</p></li>
<li><p>Remember how much we wrote, and if we still have more data to write, wait for the connection to become writable again.</p></li>
</ul>


<p>This buffered IO pattern is common enough that Libevent provides a generic mechanism for it. A &ldquo;bufferevent&rdquo; consists of an underlying transport (like a socket), a read buffer, and a write buffer. Instead of regular events, which give callbacks when the underlying transport is ready to be read or written, a bufferevent invokes its user-supplied callbacks when it has read or written enough data.</p></blockquote>

<h4>使用</h4>

<p>我们可以将新建的监听套接字绑定在event上帮我们处理后续的事件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">listener_event</span><span class="p">;</span>
</span><span class='line'><span class="n">serveListen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'><span class="n">evutil_make_socket_nonblocking</span><span class="p">(</span><span class="n">listener</span><span class="p">);</span>
</span><span class='line'><span class="n">listener_event</span> <span class="o">=</span> <span class="n">event_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">listener</span><span class="p">,</span> <span class="n">EV_READ</span><span class="o">|</span><span class="n">EV_PERSIST</span><span class="p">,</span> <span class="n">do_accept</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">base</span><span class="p">);</span>
</span><span class='line'><span class="n">event_add</span><span class="p">(</span><span class="n">listener_event</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'><span class="n">event_base_dispatch</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>当有事件进入时它会主动调用<code>do_accept</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">do_accept</span><span class="p">(</span><span class="n">evutil_socket_t</span> <span class="n">listener</span><span class="p">,</span> <span class="kt">short</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">event_base</span> <span class="o">*</span><span class="n">base</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_storage</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>    <span class="n">socklen_t</span> <span class="n">slen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ss</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listener</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slen</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;accept&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="n">FD_SETSIZE</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span><span class="p">;</span>
</span><span class='line'>        <span class="n">evutil_make_socket_nonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">bev</span> <span class="o">=</span> <span class="n">bufferevent_socket_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">BEV_OPT_CLOSE_ON_FREE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">bufferevent_setcb</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">readcb</span><span class="p">,</span> <span class="n">writecb</span><span class="p">,</span> <span class="n">errorcb</span><span class="p">,</span> <span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">fd</span><span class="p">));</span>
</span><span class='line'>        <span class="n">bufferevent_setwatermark</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_LINE</span><span class="p">);</span>
</span><span class='line'>        <span class="n">bufferevent_enable</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="o">|</span><span class="n">EV_WRITE</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面代码可以看出，我们从<code>accept</code>中接收回一个套接字，并将该套接字绑定在一个<code>bufferevent</code>，设置好相应的读写函数与读写触发的水位线加入到<code>base</code>里便可以从容的等待事件的触发了。</p>

<p>关于水位线，这里也有段详细的描述：</p>

<blockquote><p>Every bufferevent has two data-related callbacks: a read callback and a write callback. By default, the read callback is called whenever any data is read from the underlying transport, and the write callback is called whenever enough data from the output buffer is emptied to the underlying transport. You can override the behavior of these functions by adjusting the read and write &ldquo;watermarks&rdquo; of the bufferevent.</p>

<p>Every bufferevent has four watermarks:</p>

<ul>
<li><code>Read low-water mark</code></li>
</ul>


<p>Whenever a read occurs that leaves the bufferevent’s input buffer at this level or higher, the bufferevent’s read callback is invoked. Defaults to 0, so that every read results in the read callback being invoked.</p>

<ul>
<li><code>Read high-water mark</code></li>
</ul>


<p>If the bufferevent’s input buffer ever gets to this level, the bufferevent stops reading until enough data is drained from the input buffer to take us below it again. Defaults to unlimited, so that we never stop reading because of the size of the input buffer.</p>

<ul>
<li><code>Write low-water mark</code></li>
</ul>


<p>Whenever a write occurs that takes us to this level or below, we invoke the write callback. Defaults to 0, so that a write callback is not invoked unless the output buffer is emptied.</p>

<ul>
<li><code>Write high-water mark</code></li>
</ul>


<p>Not used by a bufferevent directly, this watermark can have special meaning when a bufferevent is used as the underlying transport of another bufferevent. See notes on filtering bufferevents below.</p></blockquote>

<p>细读一遍还是蛮获益匪浅的，大体意思为通过水位线的设置来触发读写的回调函数。</p>

<ul>
<li><p>对于读取水位，有读低水位与高水位，读低水位默认为0，即当buffer里数据量高于0时便会调用读回调，也就是一有数据便会回调，另一方面，当超过读的高水位时，buffer便会停止接受数据，这个值默认被置为<code>unlimited</code>，所以可以理解为永远不会停止接受数据。</p></li>
<li><p>对于写入水位，写的低水位表示当写出数据后buffer里剩余的数据量小于该水位时调用写函数，默认为0，即只有buffer被清空后该函数才会被回调。写的高水位比较特殊，一般情况下没有使用。</p></li>
</ul>


<p>对于水位线的设置是通过下面的函数实现的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">bufferevent_setwatermark</span><span class="p">(</span><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bufev</span><span class="p">,</span> <span class="kt">short</span> <span class="n">events</span><span class="p">,</span><span class="kt">size_t</span> <span class="n">lowmark</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">highmark</span><span class="p">);</span>
</span><span class='line'><span class="nl">ex:</span><span class="n">bufferevent_setwatermark</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_LINE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>在回调函数里这样获取数据：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">evbuffer</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">bufferevent_get_input</span><span class="p">(</span><span class="n">bev</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">((</span><span class="n">line</span> <span class="o">=</span> <span class="n">evbuffer_readln</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="n">EVBUFFER_EOL_LF</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">gchar</span> <span class="o">**</span><span class="n">p</span><span class="p">;</span>
</span><span class='line'>  <span class="n">p</span> <span class="o">=</span> <span class="n">g_strsplit</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;,&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="n">dispatch_request</span><span class="p">(</span><span class="n">u_data</span><span class="o">-&gt;</span><span class="n">u_id</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">g_strfreev</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是，提供的<code>evbuffer_readln</code>可以将接受到的一行数据自动去除<code>\n</code>，方便了我们的后期使用。</p>

<h2>二，实现思路</h2>

<p>具体的思路因为暂时在需求上不是很复杂所以比较简单。</p>

<p>首先实现了<code>do_accept</code>函数，阻塞接收请求建立连接的<code>socket</code>，当有新的<code>socket</code>进来后使用<code>bufferevent</code>将其包装好，并设置好它的首次读写回调函数。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">bufferevent</span> <span class="o">*</span><span class="n">bev</span><span class="p">;</span>
</span><span class='line'><span class="n">evutil_make_socket_nonblocking</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'><span class="n">bev</span> <span class="o">=</span> <span class="n">bufferevent_socket_new</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">BEV_OPT_CLOSE_ON_FREE</span><span class="p">);</span>
</span><span class='line'><span class="n">bufferevent_setcb</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">readcb</span><span class="p">,</span> <span class="n">writecb</span><span class="p">,</span> <span class="n">errorcb</span><span class="p">,</span> <span class="n">GINT_TO_POINTER</span><span class="p">(</span><span class="n">fd</span><span class="p">));</span>
</span><span class='line'><span class="n">bufferevent_setwatermark</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_LINE</span><span class="p">);</span>
</span><span class='line'><span class="n">bufferevent_enable</span><span class="p">(</span><span class="n">bev</span><span class="p">,</span> <span class="n">EV_READ</span><span class="o">|</span><span class="n">EV_WRITE</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>首次客户端的通信用于标示此次通信的目的，当为登录时，进入<code>reg_client</code>将该用户注册至服务器，并修改其回调函数用于具体的逻辑处理。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android USB Host通信]]></title>
    <link href="http://sonnewilling.com/blog/2014/04/30/android-usb-hosttong-xin/"/>
    <updated>2014-04-30T11:18:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/04/30/android-usb-hosttong-xin</id>
    <content type="html"><![CDATA[<h2>开了个头</h2>

<p>一部Android手机加上一块Arduino的板子通过USB通信可以实现很多有趣的东西。</p>

<p>2011年Google推出Android开放配件协议AOA及配件开发工具包ADK提供了Android USB或蓝牙进行通信的API，为基于Android系统的智能设备控制外设提供了条件。利用Android，系统可以连接从家用电器到重型机械、机器人等多种设备 <a href="http://www.chinaaet.com/article/216691">原文</a>。</p>

<!-- more -->


<p>想来这便是Android的魅力所在，开源的Linux系统给了任何人实现自己的梦想的可能。无需再依靠大的厂商提供的一套套完整的服务。仅仅通过自己的想象力配以几块平淡无奇的板子，便能实现一些之前看起来很高大上的东西。</p>

<h2>利其器</h2>

<p>1.Android-<a href="http://developer.android.com/sdk/index.html">ADT</a></p>

<p>Android的简单开发依赖于工具包SDK和开发工具IDE的使用。Google为我们提供的ADT打包了完善的开发工具：</p>

<blockquote><p>Eclipse + ADT plugin</p>

<p>Android SDK Tools</p>

<p>Android Platform-tools</p>

<p>The latest Android platform</p>

<p>The latest Android system image for the emulator</p></blockquote>

<p>这里还不得不提的是一个关于Android模拟器的问题。用过eclipse的都知道，上面自带的模拟器速度奇慢，尤其当适应了iPhone开发后对其更是不能忍受。这里有一篇文章便是专门讲解了下为毛Android的模拟器这么慢-<a href="http://stackoverflow.com/questions/1584617/simulator-or-emulator-what-is-the-difference">Simulator or Emulator</a>。</p>

<p>然后便发现了这个神器-<a href="http://www.genymotion.com/">Genymotion</a>，感觉这玩意儿比苹果的模拟器还快。</p>

<p>2.<a href="http://www.arduino.cc/">Arduino</a></p>

<p>这个板子还是蛮便宜又好用的，官网的文档也全，基本跟着读一遍就知道大体的开发的流程了，提供的IDE有点坑，只能设为9号字体，倒是可以调大，调大的话光标根本对不上&hellip;</p>

<p><img src="http://sonnewilling.com/images/tec/androidusb/arduino.png" alt="image" /></p>

<p>示例的代码做了个简单的读数据的功能，每次读一行然后原样返回。</p>

<p>开头的setup那里设置了<a href="http://en.wikipedia.org/wiki/Baud">波特率</a>，大体上波特率跟每秒发送的信息量有关。手上的这块板子经过简单的测试，有如下数据：</p>

<blockquote><p>波特率为9600时，每次可以携带129个字节，间隔极限在150ms</p>

<p>波特率为14400时，每次可以携带191个字节，间隔极限在260ms</p></blockquote>

<p>个人推测大概越好的板子每次能携带的信息量越大且时间间隔越短吧，即所谓的可以支持很高的波特率。</p>

<p>有了上面这两套东西基本上就可以开始USB通信了。</p>

<h2>幕前</h2>

<p>关于详细的实现Google的教程上有个快速简易的介绍，一般跟着做是可以实现效果的-<a href="http://developer.android.com/guide/topics/connectivity/usb/index.html">USB Host and Accessory</a>。稍微了解过Android开发的看着玩意儿没啥问题。基本上就是在<code>manifest</code>里对指定的activity配置下权限就妥了，它还提供了一个<code>device_filter</code>的xml文件，可以过滤指定的USB设备。</p>

<p>因为要在Andorid上做开发然后测试与Arduino，所以免不了要先往Android上写程序再让这俩东西连接，老是这样往复的在几台设备间插拔效率太低，Google提供给我们的解决方案是让Android通过Wifi连电脑，然后Android与Arduino一直连着线就妥了。</p>

<p>照着试了几遍，别人的电脑一连就妥，我的死活不行，也不知是不是苹果机的缘故。无奈实在没有插来插去的兴趣，所以又研究了下Genymotion，因为它是依托在VirtualBox上的，总觉得可以一搞。</p>

<p>多次尝试后发现，可以先将Arduino板插上电脑，如下图会出现这个设备，添加虚拟机对它的过滤，这之后把板子拔下来再插回去的话虚拟机也即Android模拟器便可以接收到Arduino板子的信号了。想要对板子连电脑烧程序的话，则反过来，先取消对板子的过滤，插拔一次便连上电脑了。</p>

<p><img src="http://sonnewilling.com/images/tec/androidusb/usbbox.png" alt="image" /></p>

<p>具体的实现大体分为四步：<a href="http://developer.android.com/guide/topics/connectivity/usb/index.html">USB Host and Accessory</a></p>

<h4>一，Obtaining permission to communicate with a device</h4>

<p>先实例化一个<code>UsbManager</code>，通过它来获取USB连接的权限。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">UsbManager</span> <span class="n">mUsbManager</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsbManager</span><span class="o">)</span> <span class="n">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">USB_SERVICE</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACTION_USB_PERMISSION</span> <span class="o">=</span>
</span><span class='line'>    <span class="s">&quot;com.android.example.USB_PERMISSION&quot;</span><span class="o">;</span>
</span><span class='line'><span class="n">mPermissionIntent</span> <span class="o">=</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getBroadcast</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="n">ACTION_USB_PERMISSION</span><span class="o">),</span> <span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="n">IntentFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">(</span><span class="n">ACTION_USB_PERMISSION</span><span class="o">);</span>
</span><span class='line'><span class="n">registerReceiver</span><span class="o">(</span><span class="n">mUsbReceiver</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
</span><span class='line'><span class="n">UsbDevice</span> <span class="n">device</span><span class="o">;</span>
</span><span class='line'><span class="n">mUsbManager</span><span class="o">.</span><span class="na">requestPermission</span><span class="o">(</span><span class="n">device</span><span class="o">,</span> <span class="n">mPermissionIntent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>权限获取：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACTION_USB_PERMISSION</span> <span class="o">=</span>
</span><span class='line'>    <span class="s">&quot;com.android.example.USB_PERMISSION&quot;</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">final</span> <span class="n">BroadcastReceiver</span> <span class="n">mUsbReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">ACTION_USB_PERMISSION</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">UsbDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsbDevice</span><span class="o">)</span><span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">UsbManager</span><span class="o">.</span><span class="na">EXTRA_DEVICE</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getBooleanExtra</span><span class="o">(</span><span class="n">UsbManager</span><span class="o">.</span><span class="na">EXTRA_PERMISSION_GRANTED</span><span class="o">,</span> <span class="kc">false</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">if</span><span class="o">(</span><span class="n">device</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
</span><span class='line'>                      <span class="c1">//call method to set up device communication</span>
</span><span class='line'>                   <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;permission denied for device &quot;</span> <span class="o">+</span> <span class="n">device</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<h4>二，Enumerating devices</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">UsbDevice</span><span class="o">&gt;</span> <span class="n">deviceList</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">getDeviceList</span><span class="o">();</span>
</span><span class='line'><span class="n">Iterator</span><span class="o">&lt;</span><span class="n">UsbDevice</span><span class="o">&gt;</span> <span class="n">deviceIterator</span> <span class="o">=</span> <span class="n">deviceList</span><span class="o">.</span><span class="na">values</span><span class="o">().</span><span class="na">iterator</span><span class="o">();</span>
</span><span class='line'><span class="k">while</span><span class="o">(</span><span class="n">deviceIterator</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()){</span>
</span><span class='line'>    <span class="n">UsbDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="n">deviceIterator</span><span class="o">.</span><span class="na">next</span><span class="o">()</span>
</span><span class='line'>    <span class="c1">//your code</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>三，Communicating with a device</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">Byte</span><span class="o">[]</span> <span class="n">bytes</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kt">boolean</span> <span class="n">forceClaim</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'><span class="n">UsbInterface</span> <span class="n">intf</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="na">getInterface</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="n">UsbEndpoint</span> <span class="n">endpoint</span> <span class="o">=</span> <span class="n">intf</span><span class="o">.</span><span class="na">getEndpoint</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'><span class="n">UsbDeviceConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">mUsbManager</span><span class="o">.</span><span class="na">openDevice</span><span class="o">(</span><span class="n">device</span><span class="o">);</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="na">claimInterface</span><span class="o">(</span><span class="n">intf</span><span class="o">,</span> <span class="n">forceClaim</span><span class="o">);</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="na">bulkTransfer</span><span class="o">(</span><span class="n">endpoint</span><span class="o">,</span> <span class="n">bytes</span><span class="o">,</span> <span class="n">bytes</span><span class="o">.</span><span class="na">length</span><span class="o">,</span> <span class="n">TIMEOUT</span><span class="o">);</span> <span class="c1">//do in another thread</span>
</span></code></pre></td></tr></table></div></figure>


<h4>四，Terminating communication with a device</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">BroadcastReceiver</span> <span class="n">mUsbReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">action</span> <span class="o">=</span> <span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">UsbManager</span><span class="o">.</span><span class="na">ACTION_USB_DEVICE_DETACHED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">UsbDevice</span> <span class="n">device</span> <span class="o">=</span> <span class="o">(</span><span class="n">UsbDevice</span><span class="o">)</span><span class="n">intent</span><span class="o">.</span><span class="na">getParcelableExtra</span><span class="o">(</span><span class="n">UsbManager</span><span class="o">.</span><span class="na">EXTRA_DEVICE</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">device</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// call your method that cleans up and closes communication with the device</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>需要注意的是两者间的通讯都是以Byte形式完成的，所以作为在接收与发送的时候需要注意相关的转码工作，而且我这边实现的是一行行的读取，所以发送的时候会隐式地拼接上<code>\n</code>。</p>

<p>发送时的转码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="nf">changeEscapeSequence</span><span class="o">(</span><span class="n">String</span> <span class="n">in</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">();</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">out</span> <span class="o">=</span> <span class="n">unescapeJava</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">out</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>  
</span><span class='line'><span class="kd">private</span> <span class="n">String</span> <span class="nf">unescapeJava</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">str</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>       <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="o">;</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span>
</span><span class='line'>   <span class="n">StringBuffer</span> <span class="n">unicode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">(</span><span class="mi">4</span><span class="o">);</span>
</span><span class='line'>   <span class="n">StringBuilder</span> <span class="n">strout</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
</span><span class='line'>   <span class="kt">boolean</span> <span class="n">hadSlash</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>   <span class="kt">boolean</span> <span class="n">inUnicode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>   <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span class='line'>       <span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(</span><span class="n">inUnicode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>           <span class="c1">// if in unicode, then we&#39;re reading unicode</span>
</span><span class='line'>           <span class="c1">// values in somehow</span>
</span><span class='line'>           <span class="n">unicode</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>           <span class="k">if</span> <span class="o">(</span><span class="n">unicode</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">==</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>               <span class="c1">// unicode now contains the four hex digits</span>
</span><span class='line'>               <span class="c1">// which represents our unicode character</span>
</span><span class='line'>               <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                   <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span><span class="n">unicode</span><span class="o">.</span><span class="na">toString</span><span class="o">(),</span> <span class="mi">16</span><span class="o">);</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">value</span><span class="o">);</span>
</span><span class='line'>                   <span class="n">unicode</span><span class="o">.</span><span class="na">setLength</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>                   <span class="n">inUnicode</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>                   <span class="n">hadSlash</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>               <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">NumberFormatException</span> <span class="n">nfe</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                   <span class="c1">// throw new NestableRuntimeException(&quot;Unable to parse unicode value: &quot; + unicode, nfe);</span>
</span><span class='line'>                   <span class="k">throw</span> <span class="k">new</span> <span class="nf">IOException</span><span class="o">(</span><span class="s">&quot;Unable to parse unicode value: &quot;</span> <span class="o">+</span> <span class="n">unicode</span><span class="o">,</span> <span class="n">nfe</span><span class="o">);</span>
</span><span class='line'>               <span class="o">}</span>
</span><span class='line'>           <span class="o">}</span>
</span><span class='line'>           <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>       <span class="k">if</span> <span class="o">(</span><span class="n">hadSlash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>           <span class="c1">// handle an escaped value</span>
</span><span class='line'>           <span class="n">hadSlash</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>           <span class="k">switch</span> <span class="o">(</span><span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;\\&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\\&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;\&#39;&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\&#39;&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;\&quot;&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;&quot;&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;r&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\r&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\f&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;t&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\t&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\n&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;b&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\b&#39;</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>               <span class="k">case</span> <span class="sc">&#39;u&#39;</span><span class="o">:</span>
</span><span class='line'>                   <span class="o">{</span>
</span><span class='line'>                       <span class="c1">// uh-oh, we&#39;re in unicode country....</span>
</span><span class='line'>                       <span class="n">inUnicode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>                       <span class="k">break</span><span class="o">;</span>
</span><span class='line'>                   <span class="o">}</span>
</span><span class='line'>               <span class="k">default</span> <span class="o">:</span>
</span><span class='line'>                   <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>                   <span class="k">break</span><span class="o">;</span>
</span><span class='line'>           <span class="o">}</span>
</span><span class='line'>           <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>       <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>           <span class="n">hadSlash</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>           <span class="k">continue</span><span class="o">;</span>
</span><span class='line'>       <span class="o">}</span>
</span><span class='line'>       <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="k">if</span> <span class="o">(</span><span class="n">hadSlash</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>       <span class="c1">// then we&#39;re in the weird case of a \ at the end of the</span>
</span><span class='line'>       <span class="c1">// string, let&#39;s output it anyway.</span>
</span><span class='line'>       <span class="n">strout</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;\\&#39;</span><span class="o">);</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'>   <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">strout</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接收时的转码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">setSerialDataToTextView</span><span class="o">(</span><span class="kt">int</span> <span class="n">disp</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">rbuf</span><span class="o">,</span> <span class="kt">int</span> <span class="n">len</span><span class="o">,</span> <span class="n">String</span> <span class="n">sCr</span><span class="o">,</span> <span class="n">String</span> <span class="n">sLf</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">mText</span><span class="o">.</span><span class="na">append</span><span class="o">((</span><span class="kt">char</span><span class="o">)</span> <span class="n">rbuf</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>正主</h2>

<p>其实最后在各种测试的时候没有用Google的这个原始流程，在网上发现了一份比较完整的USB通讯示例流程-<a href="https://github.com/ksksue/Android-USB-Serial-Monitor-Lite">Android-USB-Serial-Monitor-Lite</a>，直接用它提供的各种工具做的测试&hellip;我的测试代码在这里<a href="https://github.com/wanax/android_usb_test">android_usb_test</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UNIX下的Socket通信-TCP/IP基本概念]]></title>
    <link href="http://sonnewilling.com/blog/2014/03/20/unixxia-de-sockettong-xin-tcp-slash-ipji-ben-gai-nian/"/>
    <updated>2014-03-20T18:44:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/03/20/unixxia-de-sockettong-xin-tcp-slash-ipji-ben-gai-nian</id>
    <content type="html"><![CDATA[<h2>总览</h2>

<blockquote><p>All problems in computer science can be solved by another level of indirection</p></blockquote>

<p>觉得这句话对TCP的分层也很适用。</p>

<p>对TCP/IP协议来说，大体分为五层，</p>

<ol>
<li>应用层</li>
<li>传输层</li>
<li>网络层</li>
<li>链路层</li>
<li>物理层</li>
</ol>


<p>应用层我们接触的比较多，流行的如HTTP，FTP之类都算，像我在大学里做的PHP开发时基本对HTTP发包没有任何概念，照着教程开eclipse，apache，在浏览器里敲个<code>locahost:8080</code>出来个猫的图案就很开心了。再建个index，上面写句“未满18周岁禁止进入”，就有种天下在手的感觉。</p>

<!--more-->


<p>后来做java网站，用到了HttpClient，逐渐对HTTP的抓包发包有了简单地了解。通过这玩意儿就可以做到绕过网页填写，直接后台模拟网页提交表单，那些抢票软件大体上就是这个思路。</p>

<p>再往下便是闻名已久的传输层（TCP,UPD,SCTP etc.）与网络层(IPv4,IPv6 etc.)了。</p>

<h2>网络的划分</h2>

<p><img src="http://sonnewilling.com/images/tec/Socket/hierarchy.png" alt="image" /></p>

<p>通过上图可以很直观的看到应用层的实体数据经过层层的包装最终封印在了链路层中在物理层中进行传输。其中每一层实体间交换的单位信息称为<em>协议数据单元(protocol data unit,PDU)</em>。每层的PDU作为下层的<em>数据服务单元（service data unit,SDU）</em>传递给下层，并由下层间接完成本层的PDU交换。</p>

<p>为了避免诸如TCP的PDU，IP的PDU这类很不简洁的称呼，国际上给每层的PDU都另外取了自己的名字。传输层的称为<em>segment（分节）</em>，网络层的称为<em>IP datagram（IP数据报）</em>，链路层的称为<em>frame（帧）</em></p>

<p>而关于层与层间的打包封印也有它们不得不说的故事，那就是分片。简单的说如果本层PDU的大小超过紧邻下层的最大SDU限制，那么本层还要事先把PDU划分成若干个合适的片段让下层分开载送，再在相反方向把这些片段重组成PDU。同一层内SDU作为PDU的净荷（payload）字段出现，因此可以说上层PDU作为本层的SDU字段由本层PDU承载。如上图所示每层PDU除用于承载紧邻上层的PDU（即承载数据外），也用于承载本层协议内部通讯所需的控制信息（各种header）。</p>

<p>当然这只是个初步的说法，下面会针对传输层与网络层展开具体一下的学习。</p>

<h3>1.传输层</h3>

<p>一说传输层TCP，讲不通三次握手连接，四次握手关闭都不好意思出来混。</p>

<h4>先看连接图示：</h4>

<p><img src="http://sonnewilling.com/images/tec/Socket/connect.JPG" alt="image" /></p>

<p>图中有类似于SYN，ACK的标记量，结合上一章的内容，其实这也是TCP分节的一种。分节除了用于承载数据外，也用于建立连接（SYN分节），终止连接（FIN分节），中止连接（RST分节），确认数据接收（ACK分节），刷送待发数据（PSH分节）和携带紧急数据指针（URG分节），而且这些功能（包括承载数据）可以灵活组合。</p>

<p>也就是说在建立连接的初期，由Socket自带的函数为我们发送分节握手沟通，握手连接建立后，则由用户自行组织分节信息进行通信。</p>

<p>关于上图的握手过程可以简单复述一下：</p>

<ol>
<li>服务器必须准备好接受外来的连接，这通常通过调用<code>socket</code>,<code>bind</code>,<code>listen</code>这三个函数来完成，称之为<em>被动打开（passive open）</em>。</li>
<li>客户通过调用<code>connect</code>发起<em>主动打开（active open）</em>。这导致客户TCP发送一个SYN（同步）分节，它告诉服务器客户将在（待建立的）连接中发送的数据的初始序列号。通常SYN分节不携带数据，其所在IP数据报只含有一个IP首部，一个TCP首部及可能有的TCP选项。</li>
<li>服务器必须确认（ACK）客户的SYN，同时自己也得发送一个SYN分节，它含有服务器将在同一连接中发送的数据的初始序列号。服务器在单个分节中发送SYN和对客户SYN的ACK。</li>
<li>客户必须确认服务器的SYN。</li>
</ol>


<p>上述过程中出现了<em>SYN_SENT</em>之类的字样，它们代表了套接字的状态。在<code>socket</code>函数初始化后套接字的状态为<em>CLOSED</em>，<code>connect</code>函数导致当前套接字从<em>CLOSED</em>状态转移到<em>SYN_SENT</em>状态，若成功则在转移到<em>ESTABLISHED</em>状态。<em>若<code>connect</code>失败则该套接字不再可用，必须关闭，不可以对这样的套接字再次调用<code>connect</code>函数，而是在每次失败后，必须<code>close</code>当前的套接字描述符并重新调用<code>socket</code></em>。</p>

<h4>再来个关闭图示：</h4>

<p><img src="http://sonnewilling.com/images/tec/Socket/close.JPG" alt="image" /></p>

<ol>
<li>某个应用进程首先调用<code>close</code>，称该端执行<em>主动关闭（active close）</em>，该端的TCP于是发送一个FIN终止分节，表示数据发送完毕。</li>
<li>接收到这个FIN对端执行<em>被动关闭（passive close）</em>。这个FIN由TCP确认。它的接收也作为一个<em>文件结束符（end-of-file）</em>传递给接收端应用进程（放在已排队等候该应用进程接收的任何其它数据之后），因为FIN的接收意味着接收端应用进程在相应连接上再无额外的数据可接收。</li>
<li>一段时间后，接收到这个文件结束符的应用进程将调用<code>close</code>关闭它的套接字。这导致了它的TCP也发送一个FIN。</li>
<li>接收这个最终FIN的原发送端TCP（即执行主动关闭的那一端）确认这个FIN。</li>
</ol>


<p>在握手连接的过程中，套接字通过发送SYN（建立连接分节）经历了COLSE，SYN_SENT，ESTABLISHED等状态，达到了可以通信的目的。而在四次关闭握手连接中，套接字也要经历几种状态，达到真正关闭的目的，<em>需要注意的是，因为TCP是全双工的，所以正常情况下的关闭需要经过双方的确认才可以完全关闭，这就需要通信两端都分别发送自己的FIN信号，且回应对方的FIN，因此理论上关闭握手需要四次，每个套接字各两次。</em></p>

<ol>
<li>FIN_WAIT_1：<em>主动方</em>套接字在ESTABLISHED状态正常通信时，它想主动关闭连接，于是向对方发送了FIN报文，此时该套接字即进入到FIN_WAIT_1状态。而当对方回应ACK报文后，则进入到FIN_WAIT_2状态。</li>
<li>FIN_WAIT_2：<em>主动方</em>通俗的讲便是我已经完成任务并且告知对端完成我方的关闭，然后我在等你发送你的FIN，要是你还有什么话说那赶紧，我这边该说的都说完了&hellip;</li>
<li>CLOSE_WAIT：<em>被动方</em>对应的是FIN_WAIT_2状态，便是在正常ESTABLISHED状态下收到了对端的FIN信号，但我还有活没做完，需要搞定后才往你那儿发送FIN终止信号，此时的状态便是CLOSE_WAIT。</li>
<li>LAST_ACK：<em>被动方</em>被动关闭一方在发送FIN报文后，最后等待对方的ACK报文。</li>
<li>TIME_WAIT：<em>主动方</em>表示收到了对方的FIN报文，并发送出了ACK报文，就等2MSL后即可回到CLOSED可用状态了。如果FIN_WAIT_1状态下，收到了对方同时带 FIN标志和ACK标志的报文时，可以直接进入到TIME_WAIT状态，而无须经过FIN_WAIT_2状态。</li>
</ol>


<p>在这些状态中，比较不好理解的是TIME_WAIT状态。我们看到执行主动关闭的一方经历了这个状态。该端点停留在这个状态的持续时间是<em>最长分节生命期（maximum segment lifetime，MSL）</em>的两倍，有时候称之为2MSL。</p>

<p>任何TCP实现都必须为MSL选择一个值。其时间在1分钟到4分钟之间。MSL是任何IP数据报能够在因特网中存活的最长时间。因为每个数据报含有一个称为<em>跳限（hop limit）</em>的8位字段，它的最大值为255.一般上假设：</p>

<blockquote><p>具有最大跳限（255）的分组在网络中存在的时间不可能超过MSL秒。</p></blockquote>

<p>所以TIME_WAIT状态有两个存在的理由，</p>

<ol>
<li>可靠地实现TCP全双工连接的终止。TCP连接在主动关闭方发送的最后一个ACK(FIN)，有可能丢失，这时被动方会重新发FIN, 如果这时主动方处于CLOSED状态 ，就会响应RST而不是ACK。所以主动方要处于TIME_WAIT状态，而不能是CLOSED。</li>
<li>允许老的重复分节在网络中消逝，因为经过2MSL，上一次连接中所有的重复包都会消失。</li>
</ol>


<p>最后放一张TCP中套接字的状态大图~</p>

<p><img src="http://sonnewilling.com/images/tec/Socket/status.png" alt="image" /></p>

<h3>2.网络层</h3>

<p>因为主体是使用TCP的Socket进行编程，这里对网络层的具体细节就不做探讨了。但关于网络层还会牵扯到分片的问题，这里需要重视起来。</p>

<p>在TCP传输层中，发送端TCP把来自应用进程的字节流数据（即由应用进程通过一次次输出操作写出到发送端TCP套接字中的数据）按顺序经分割后封装在各个分节中传送给接收端TCP，其中每个分节所封装的数据既可能是发送端应用进程单次输出操作的结果，也可能是数次输出操作的结果，而且每个分节所封装的单次输出操作的结果或者首尾两次输出操作的结果既可能是完整的，也可能是不完整的，具体取决于可在连接建立阶段由对端通告的<em>最大分节大小（maximum segment size,MSS）</em>以及<em>外出接口的最大传输单元（maximum transmission unit,MTU）</em>或<em>外出路径的路径MTU</em>。</p>

<p>MSS的目的是告诉对端其重组缓冲区大小的实际值，从而试图避免分片。MSS经常设置成MTU减去IP和TCP首部的固定长度。</p>

<p>网络层实体间交换的PDU称为IP数据报（IP datagram）,其长度有限：IPv4数据报最大长度65535字节，IPv6S数据报最大65575.发送端IP把来自传输层的消息（或TCP分节）整个封装在IP数据报中发送。链路层实体间交换的PDU称为帧（frame），其长度取决于具体的接口。IP数据报由IP首部和所承载的传输层数据（即网络层的SDU）构成。过长的IP数据报无法封装在单个帧中，需要先对其SDU进行分片（fragmentation），再把分成的各个片段（fragment）冠以新的IP首部封装到多个帧中。在一个IP数据报从源端到目的端的传送过程中，分片操作既可能发生在源端，也可能发生在途中，而其逆操作即重组（reassembly）一般只发生在目的端。</p>

<p>TCP/IP协议族为提高效率会尽可能避免IP的分片/重组操作：TCP根据MSS和MTU限定每个分节的大小，且在途中尽量避免分片操作。不论是否分片都由IP作为链路层的SDU传入链路层，并由链路层封装在帧中数据称为分组（packet，俗称包）。可见一个分组既可能是一个完整地IP数据报，也可能是某个IP数据报的SDU的一个片段被冠以新的IP首部后的结果。</p>

<h2>下一步</h2>

<p>总结了基本套接字函数的使用与TCP/IP的简单概念，下一步将会着手编写一套客户/服务器的通信演示Demo，会考虑实现线程池来提高并发效率。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UNIX下的Socket通信-Socket的连接]]></title>
    <link href="http://sonnewilling.com/blog/2014/03/20/unixxia-de-sockettong-xin-Socket-de-lian-jie/"/>
    <updated>2014-03-20T15:55:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/03/20/unixxia-de-sockettong-xin-Socket-de-lian-jie</id>
    <content type="html"><![CDATA[<h2>一.关于Socket</h2>

<p>如我，刚见这个名词的时候不知所云，因为起点就没找对，首先要在基于对UNIX有所了解的情况下才利于开展工作，便是“一切皆文件”。</p>

<p>在UNIX下，一般的文件可以通过open打开，并返回一个小整数作为标记，后续的操作便是针对这个小整数进行读写。这个小整数被称作<em>描述符</em>，描述符只是引用file的proc结构中一个数组的某个元素的下标而已，它可以代表该文件，但并不是文件本身，我们通过它来与文件建立联系，方便操作。</p>

<p>以此为前提，Socket便是一种特殊的文件，通过<em>socket</em>函数可以创建一个套接字（特殊的文件），它也返回给我们一个小整数，以后所有的函数调用就用该描述符来标示这个套接字。</p>

<p>在UNIX下文件的种类有很多，打开与使用的方式虽然遵循着一定的模式，但也不尽相同。比如想打开一个文本文件需要借助open函数，而且在打开的时候需要告诉open函数该文本的路径位置，以明确打开的目标。</p>

<!--more-->


<p>Socket的打开也与之相似，因为它一定程度上可以理解为是一个联网通信的文件，所以如果想要明确打开的目标，肯定不能传送一个本地路径，而要与之相符地传送一个目标IP地址。当然这只是简单的比喻，Socket的建立要比文件要复杂一些，IP地址的设置只是打开过程的一个步骤，因为涉及到了网络的缘故，还需要设置很多参数。毕竟文本文件是自己的，打开的标准关上门来自己做主，怎么方便都好商量。而Socket则不一样，既然是在各种主机间通信，且走的路线均不一样，这就牵扯到了各种配置。</p>

<h2>二.TCP下IPv4的Socket连接</h2>

<h3>1.socket</h3>

<p>让我们来看Socket建立的第一步的函数</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>明显的，单是第一步就比open函数多参数。</p>

<p>其中family参数指明协议族，type指明套接字类型，protocol为某个协议的常值类型，或者设为0。</p>

<h4>socket函数的type常值</h4>

<table>
<thead>
<tr>
<th></th>
<th>       type          </th>
<th>        说明         </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> SOCK_STREAM    </td>
<td>    字节流套接字   </td>
</tr>
<tr>
<td></td>
<td> SOCK_DGRAM     </td>
<td>     数据报套接字  </td>
</tr>
<tr>
<td></td>
<td>SOCK_SEQPACKET  </td>
<td>    有序分组套接字 </td>
</tr>
<tr>
<td></td>
<td>   SOCK_RAW     </td>
<td>     原始套接字   </td>
</tr>
</tbody>
</table>


<h4>socket函数protocol常值</h4>

<table>
<thead>
<tr>
<th></th>
<th>    protocol     </th>
<th>        说明         </th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
<td> IPPROTO_TCP    </td>
<td>    TCP传输协议   </td>
</tr>
<tr>
<td></td>
<td> IPPROTO_UDP    </td>
<td>     UDP传输协议  </td>
</tr>
<tr>
<td></td>
<td> IPPROTO_SCTP   </td>
<td>    SCTP传输协议  </td>
</tr>
</tbody>
</table>


<p>所以如果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>则表示socket函数创建一个网际（AF_INET）字节流（SOCK_STREAM）套接字。</p>

<h3>2.connect</h3>

<p>第一步的socket函数只是把一些基本的参数设置好并返回了一个描述符，就像安好了电话，但其实并没有开始扯线连接，connect帮我们搞定这一步。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">servaddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>socket是由socket返回的套接字描述符，第二个，第三个参数分别是一个指向套接字地址结构的指针和该结构的大小。套接字地址结构必须含有服务器的IP地址和端口号。</p>

<p>关于sockaddr的结构大体如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">sa_family_t</span>    <span class="n">sin_family</span><span class="p">;</span> <span class="cm">/* address family: AF_INET */</span>
</span><span class='line'>    <span class="n">in_port_t</span>      <span class="n">sin_port</span><span class="p">;</span>   <span class="cm">/* port in network byte order */</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">in_addr</span> <span class="n">sin_addr</span><span class="p">;</span>   <span class="cm">/* internet address */</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>对此结构一般的设置方法如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
</span><span class='line'><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">13</span><span class="p">);</span><span class="c1">//服务器端口</span>
</span><span class='line'><span class="n">inet_pton</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="s">&quot;192.168.105.105&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">);</span><span class="c1">//服务器地址</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为具体的连接动作是使用网络字节序的，并不是我们所见到的诸如<code>192.168.105.105:13</code>之类的表达，所以需要htons与inet_pton进行相应的转换。<em>htons()主机到网络短整数，转换二进制端口号</em>，地址转换函数在地址的文本表达式和它们存放在套接字地址结构中的二进制值之间转换。</p>

<p>如果是写一个客户端的请求程序，那么前两个函数就可以满足要求建立了套接字，下一步的动作便是针对该套接字返回的描述符进行相应的读写便可以了。但要是想做一个服务器端的进程具有监听功能的话则还需要另外下面这三个函数。</p>

<h3>3.bind，listen，accept</h3>

<blockquote><p>打个简单的比喻，建立TCP连接就好比一个电话系统。socket函数等同于有电话可用。connect要求我们知道对方的电话号码并拨打它。bind函数是在告诉别人你的电话号码，这样他们可以呼叫你。listen是打开电话振铃，这样当有个外来呼叫到来时，你可以听到。accept则相当于接电话。</p></blockquote>

<p>对于服务器端的socket addr的初始化如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">bzero</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
</span><span class='line'><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span>      <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
</span><span class='line'><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span>        <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">SERV_PORT</span><span class="p">);</span>
</span><span class='line'><span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>它区别于客户端的套接字初始化在于第四行，并没有指定目标IP地址，代之的是一个INADDR_ANY的宏，它可以表示我接收来自任何地址的请求。
如果想要真正实现这一目的，我们需要调用bind来告知UNIX系统我这个套接字将被用来接收信号：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">bind</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="k">const</span> <span class="n">stuct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">myaddr</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="n">addrlen</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>继而取消电话的静音状态：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">listen</span><span class="p">(</span><span class="kt">int</span> <span class="n">sockfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">backlog</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>此函数通常应该在调用socket和bind这两个函数之后，并在调用accept之前调用。</p>

<p>关于backlog，是一个设置未完成连接队列与已完成连接队列的参数，这里暂不做细致的探讨了。</p>

<p>最后一步，我们的进程将阻塞于accept的调用中。accept函数由TCP服务器调用，用于从已完成的连接队列头返回下一个已完成连接。关于阻塞函数，看下面这段的讲解：</p>

<blockquote><p>永远阻塞的系统调用是指调用有可能永远无法返回，也可称为慢系统调用（slow system call），多数网络支持函数都属于这一种（accept）。适用于慢系统调用的基本规则是，当阻塞于某个慢系统调用的一个进程捕获某个信号且相应信号处理函数返回时，该系统调用可能返回一个EINTR错误。</p></blockquote>

<p>对于此类错误我们可以通过以下函数进行绕过，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">clilen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cliaddr</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">listenfd</span><span class="p">,</span> <span class="p">(</span><span class="n">SA</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">cliaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">clilen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
</span><span class='line'>              <span class="k">continue</span><span class="p">;</span>     <span class="cm">/* back to for() */</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nf">err_sys</span><span class="p">(</span><span class="s">&quot;accept error&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>以上便是一个服务器端的监听套接字的建立过程。</p>

<h3>4.close，shutdown</h3>

<p>有开就有关，关于套接字的关闭我们一般使用close与shutdown来进行控制。</p>

<p>正如我们前面所述，我们通过描述符对套接字进行操作，描述符不过是对file的一个下标而已，如果有多个进程同时使用描述符，则均可以表示为对此file的一个引用。初始的引用值为1，每当调用fork以派生子进程或对打开操作返回的描述符（或其复制品）调用dup以复制描述符时，该file结构的引用计数就递增。相应的close()使相应描述符的引用计数减1，当该描述符引用计数为0时则引发正常TCP连接终止序列：每个方向上发送一个FIN，每个FIN又由各自的对端确认。如想确实在某个TCP连接上发送FIN，可以改用shutdown。</p>

<h3>5.最后无图无真相:</h3>

<p><img src="http://sonnewilling.com/images/tec/Socket/funtime.jpg" alt="image" /></p>

<h2>下一步</h2>

<p>这部分具体介绍了Socket的基本概念与一个客户端和服务端的套接字是怎样一步步建立起来的。但文章中也出现了一些诸如FIN之类的关键字并没有进行详细的解释，在下一章，我会对TCP/IP的一些基本概念进行解释。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[GLib编译笔记]]></title>
    <link href="http://sonnewilling.com/blog/2014/03/13/glibbian-yi-bi-ji/"/>
    <updated>2014-03-13T15:38:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/03/13/glibbian-yi-bi-ji</id>
    <content type="html"><![CDATA[<h3>缘起</h3>

<p>最近做的一个项目是使用C写的，随着项目的深入发现需要通过不同的数据结构来完成需求，自己简单地去编写已经不能满足要求且在健壮性方面也存在着隐患，于是就琢磨着在网上找找看看有没有什么现成的C工具包来用，就这样，发现了GLib。</p>

<p>先来看下维基上的介绍：</p>

<blockquote><p>GLib是一个跨平台的、用C语言编写的库，起初是GTK+的一部分，但到了GTK+第二版，开发者决定把跟图形界面无关的代码分开，这些代码于是就组装成了GLib。GLib提供了多种高级的数据结构，如内存块、双向和单向链表、哈希表、动态字符串等。</p></blockquote>

<p>感觉功能刚好满足需要，类似于C++中的STL，果断搞起。</p>

<!--more-->


<h3>1.下载</h3>

<p>从网上搜索GLib找到了这里<a href="http://www.linuxfromscratch.org/blfs/view/svn/general/glib2.html">Linux From Scratch</a>，下载它的压缩包。</p>

<p>这个网站也把具体的编译安装方式写得很明白。</p>

<blockquote><h3>GLib Dependencies</h3>

<h4>Required</h4>

<p><a href="http://www.linuxfromscratch.org/blfs/view/svn/general/libffi.html">libffi-3.0.13</a> and <a href="http://www.linuxfromscratch.org/blfs/view/svn/general/python2.html">Python-2.7.6</a></p>

<h4>Recommended</h4>

<p><a href="http://www.linuxfromscratch.org/blfs/view/svn/general/pcre.html">PCRE-8.34</a>(built with Unicode properties)</p>

<h4>Optional</h4>

<p><a href="http://www.linuxfromscratch.org/blfs/view/svn/postlfs/attr.html">attr-2.4.47</a>, <a href="http://www.linuxfromscratch.org/blfs/view/svn/general/dbus.html">D-Bus-1.8.0</a> (required to run the tests), and <a href="http://www.linuxfromscratch.org/blfs/view/svn/general/gtk-doc.html">GTK-Doc-1.20</a></p>

<h4>Additional Runtime Dependencies</h4>

<p>Quoted directly from the INSTALL file: “Some of the mimetype-related functionality in GIO requires the update-mime-database and update-desktop-database utilities”, which are part of <a href="http://www.linuxfromscratch.org/blfs/view/svn/general/shared-mime-info.html">shared-mime-info-1.2</a> and <a href="http://www.linuxfromscratch.org/blfs/view/svn/general/desktop-file-utils.html">desktop-file-utils-0.22</a>, respectively.</p></blockquote>

<p>就是说想要安装GLib的话最起码得先把Required和Recommended里的东西装完才行。</p>

<p>但在实际安装过程中还需要另外两个工具<a href="http://www.chenjunlu.com/2011/03/understanding-pkg-config-tool/">pkg-config</a>和<a href="http://zh.wikipedia.org/wiki/Gettext">Gettext</a></p>

<p>对于两者皆是去官网下载最新版本的安装包，执行安装命令就可以了。</p>

<p><a href="http://pkgconfig.freedesktop.org/releases/">pkg-config</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span>  <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">internal</span><span class="o">-</span><span class="n">glib</span>
</span><span class='line'><span class="n">make</span>
</span><span class='line'><span class="n">sudo</span>  <span class="n">make</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://www.gnu.org/software/gettext/">Gettext</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">configure</span>
</span><span class='line'><span class="err">$</span> <span class="n">make</span>
</span><span class='line'><span class="err">$</span> <span class="n">make</span> <span class="n">verify</span>   <span class="err">#</span> <span class="p">(</span><span class="n">optional</span><span class="p">)</span>
</span><span class='line'><span class="err">$</span> <span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<h3>2.编译</h3>

<p>安装环境配好后就可以正式安装了，顺着那个网页往下走就能看到具体的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="o">--</span><span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span> <span class="o">--</span><span class="n">with</span><span class="o">-</span><span class="n">pcre</span><span class="o">=</span><span class="n">system</span> <span class="o">&amp;&amp;</span> <span class="n">make</span>
</span></code></pre></td></tr></table></div></figure>


<p>再然后</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<p>GLib在gcc里的使用是借助了一个叫pkg-configure的工具，这玩意儿的作用这位哥儿们说得很详细了，看他的介绍吧：<a href="http://www.chenjunlu.com/2011/03/understanding-pkg-config-tool/">理解 pkg-config 工具</a></p>

<p>其实定位到<code>/usr/lib/pkgconfigure</code>后会发现它里面放了很多你自己安装的库的.pc的配置文件，用vim随便打开一个发现它的内容是这样的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>   <span class="n">prefix</span><span class="o">=/</span><span class="n">usr</span>
</span><span class='line'>   <span class="n">exec_prefix</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">prefix</span><span class="p">}</span>
</span><span class='line'>   <span class="n">libdir</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">exec_prefix</span><span class="p">}</span><span class="o">/</span><span class="n">lib</span>
</span><span class='line'>   <span class="n">includedir</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">prefix</span><span class="p">}</span><span class="o">/</span><span class="n">include</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'>   <span class="n">glib_genmarshal</span><span class="o">=</span><span class="n">glib</span><span class="o">-</span><span class="n">genmarshal</span>
</span><span class='line'>   <span class="n">gobject_query</span><span class="o">=</span><span class="n">gobject</span><span class="o">-</span><span class="n">query</span>
</span><span class='line'>   <span class="n">glib_mkenums</span><span class="o">=</span><span class="n">glib</span><span class="o">-</span><span class="n">mkenums</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'>   <span class="nl">Name:</span> <span class="n">GLib</span>
</span><span class='line'>   <span class="nl">Description:</span> <span class="n">C</span> <span class="n">Utility</span> <span class="n">Library</span>
</span><span class='line'>   <span class="nl">Version:</span> <span class="mf">2.38.2</span>
</span><span class='line'>   <span class="n">Requires</span><span class="p">.</span><span class="n">private</span><span class="o">:</span> <span class="n">libpcre</span>
</span><span class='line'>   <span class="nl">Libs:</span> <span class="o">-</span><span class="n">L</span><span class="err">$</span><span class="p">{</span><span class="n">libdir</span><span class="p">}</span> <span class="o">-</span><span class="n">lglib</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">-</span><span class="n">lintl</span>
</span><span class='line'>   <span class="n">Libs</span><span class="p">.</span><span class="n">private</span><span class="o">:</span>   <span class="o">-</span><span class="n">lpcre</span>  <span class="o">-</span><span class="n">lintl</span>  <span class="o">-</span><span class="n">liconv</span>
</span><span class='line'>   <span class="nl">Cflags:</span> <span class="o">-</span><span class="n">I</span><span class="err">$</span><span class="p">{</span><span class="n">includedir</span><span class="p">}</span><span class="o">/</span><span class="n">glib</span><span class="o">-</span><span class="mf">2.0</span> <span class="o">-</span><span class="n">I</span><span class="err">$</span><span class="p">{</span><span class="n">libdir</span><span class="p">}</span><span class="o">/</span><span class="n">glib</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="n">include</span>
</span></code></pre></td></tr></table></div></figure>


<p>看一下就明白了，基本上就是帮你写了一堆编译选项，免得到时候自己编译的时候要敲一坨，而且在不同的电脑上编译的时候也可以动态的调整路径，不用一遍遍的去改Makefile。</p>

<p>比如说自己编译一个使用了GLib的文件，可以这样敲：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">gcc</span> <span class="err">`</span><span class="n">pkg</span><span class="o">-</span><span class="n">config</span> <span class="o">--</span><span class="n">cflags</span> <span class="o">--</span><span class="n">libs</span> <span class="n">glib</span><span class="o">-</span><span class="mf">2.0</span><span class="err">`</span>  <span class="n">hello</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span>
</span></code></pre></td></tr></table></div></figure>


<p>–cflags 参数可以给出在编译时所需要的选项，而 –libs 参数可以给出连接时的选项。</p>

<p>当然如果不使用pkg-configure的话也可以类似这样子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">gcc</span>  <span class="o">-</span><span class="n">L</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span> <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">glib</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">glib</span><span class="o">-</span><span class="mf">2.0</span> <span class="n">hello</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">o</span> <span class="n">hello</span> <span class="o">-</span><span class="n">liconv</span> <span class="o">-</span><span class="n">lresolv</span> <span class="o">-</span><span class="n">lpcre</span> <span class="o">-</span><span class="n">lintl</span> <span class="o">-</span><span class="n">lglib</span><span class="o">-</span><span class="mf">2.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以基本上还是简化了很多操作的。</p>

<h3>3.测试使用</h3>

<p>测试一下GLib中哈希表的使用吧：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;glib.h&gt;</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Glib version: %u.%u.%u</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">glib_major_version</span><span class="p">,</span><span class="n">glib_minor_version</span><span class="p">,</span><span class="n">glib_micro_version</span><span class="p">);</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'>      <span class="n">GHashTable</span><span class="o">*</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">g_hash_table_new</span><span class="p">(</span><span class="n">g_str_hash</span><span class="p">,</span> <span class="n">g_str_equal</span><span class="p">);</span>
</span><span class='line'>      <span class="n">g_hash_table_insert</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="s">&quot;Virginia&quot;</span><span class="p">,</span> <span class="s">&quot;Richmond&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">g_hash_table_insert</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="s">&quot;Texas&quot;</span><span class="p">,</span> <span class="s">&quot;Austin&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">g_hash_table_insert</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="s">&quot;Ohio&quot;</span><span class="p">,</span> <span class="s">&quot;Columbus&quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;There are %d keys in the hash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">g_hash_table_size</span><span class="p">(</span><span class="n">hash</span><span class="p">));</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The capital of Texas is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">g_hash_table_lookup</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="s">&quot;Texas&quot;</span><span class="p">));</span>
</span><span class='line'>      <span class="n">gboolean</span> <span class="n">found</span> <span class="o">=</span> <span class="n">g_hash_table_remove</span><span class="p">(</span><span class="n">hash</span><span class="p">,</span> <span class="s">&quot;Virginia&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The value &#39;Virginia&#39; was %sfound and removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">found</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'>      <span class="n">g_hash_table_destroy</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以打印如下信息：</p>

<blockquote><p>Glib version: 2.38.2</p>

<p>There are 3 keys in the hash</p>

<p>The capital of Texas is Austin</p>

<p>The value &lsquo;Virginia&rsquo; was found and removed</p></blockquote>

<h3>4.搭配Eclipse</h3>

<p>嫌敲命令行麻烦的话也可以配到Eclipse上用。现在在Eclipse上有了pkg-configure的插件，可以对GLib直接勾选使用，但我安装后没有起到效果，不知道哪里出了问题<a href="https://code.google.com/p/pkg-config-support-for-eclipse-cdt/">pkg-config-support-for-eclipse-cdt</a>。但反正原理已经知道了，索性自己配一下也就妥了。</p>

<p>选中工程，在Project里找到Properties进入到下图的界面：</p>

<p><img src="http://sonnewilling.com/images/tec/GLib/eclipsecon.png" alt="image" /></p>

<p>在Libraries里配置GLib库的位置和名字，在Includes里配置GLib头文件的位置，我的头文件在这里</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">glib</span><span class="o">-</span><span class="mf">2.0</span>
</span></code></pre></td></tr></table></div></figure>


<p>其实按照教程正常安装的话基本上都会在这个位置，这样的话就可以用Eclipse在GLib里爽起来了~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UNIX下Socket工具包libunp.a编译笔记]]></title>
    <link href="http://sonnewilling.com/blog/2014/03/12/unixxia-socketgong-ju-bao-libunp-dot-abian-yi-bi-ji/"/>
    <updated>2014-03-12T16:23:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/03/12/unixxia-socketgong-ju-bao-libunp-dot-abian-yi-bi-ji</id>
    <content type="html"><![CDATA[<p>1.README很重要，基本上跟着README走一遍就妥了，报错的话一定要仔细得去读错误信息，可以对错误的解决提供很大的帮助。我遇到的错误比较简单，是电脑里没有ar的打包指令，因为刚开始接触makefile，所以在这个不大的坑上也花了点时间才发现，还是在别人的机子上编译成功的，一对比才发现自己电脑上没有装&hellip;一定不要太自信，当时压根就没往这个方向想。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">Execute</span> <span class="n">the</span> <span class="n">following</span> <span class="n">from</span> <span class="n">the</span> <span class="n">src</span><span class="o">/</span> <span class="n">directory</span><span class="o">:</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">configure</span>    <span class="err">#</span> <span class="n">try</span> <span class="n">to</span> <span class="n">figure</span> <span class="n">out</span> <span class="n">all</span> <span class="n">implementation</span> <span class="n">differences</span>
</span><span class='line'><span class="n">cd</span> <span class="n">lib</span>         <span class="err">#</span> <span class="n">build</span> <span class="n">the</span> <span class="n">basic</span> <span class="n">library</span> <span class="n">that</span> <span class="n">all</span> <span class="n">programs</span> <span class="n">need</span>
</span><span class='line'><span class="n">make</span>           <span class="err">#</span> <span class="n">use</span> <span class="s">&quot;gmake&quot;</span> <span class="n">everywhere</span> <span class="n">on</span> <span class="n">BSD</span><span class="o">/</span><span class="n">OS</span> <span class="n">systems</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="n">cd</span> <span class="p">..</span><span class="o">/</span><span class="n">libfree</span>  <span class="err">#</span> <span class="k">continue</span> <span class="n">building</span> <span class="n">the</span> <span class="n">basic</span> <span class="n">library</span>
</span><span class='line'><span class="n">make</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="n">cd</span> <span class="p">..</span><span class="o">/</span><span class="n">libroute</span> <span class="err">#</span> <span class="n">only</span> <span class="k">if</span> <span class="n">your</span> <span class="n">system</span> <span class="n">supports</span> <span class="mf">4.4</span><span class="n">BSD</span> <span class="n">style</span> <span class="n">routing</span> <span class="n">sockets</span>
</span><span class='line'><span class="n">make</span>           <span class="err">#</span> <span class="n">only</span> <span class="k">if</span> <span class="n">your</span> <span class="n">system</span> <span class="n">supports</span> <span class="mf">4.4</span><span class="n">BSD</span> <span class="n">style</span> <span class="n">routing</span> <span class="n">sockets</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="n">cd</span> <span class="p">..</span><span class="o">/</span><span class="n">libxti</span>   <span class="err">#</span> <span class="n">only</span> <span class="k">if</span> <span class="n">your</span> <span class="n">system</span> <span class="n">supports</span> <span class="n">XTI</span>
</span><span class='line'>    <span class="n">make</span>           <span class="err">#</span> <span class="n">only</span> <span class="k">if</span> <span class="n">your</span> <span class="n">system</span> <span class="n">supports</span> <span class="n">XTI</span>
</span><span class='line'><span class="n">cd</span> <span class="p">..</span><span class="o">/</span><span class="n">intro</span>    <span class="err">#</span> <span class="n">build</span> <span class="n">and</span> <span class="n">test</span> <span class="n">a</span> <span class="n">basic</span> <span class="n">client</span> <span class="n">program</span>
</span><span class='line'><span class="n">make</span> <span class="n">daytimetcpcli</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="p">.</span><span class="o">/</span><span class="n">daytimetcpcli</span> <span class="mf">127.0.0.1</span>
</span><span class='line'><span class="o">&amp;</span>
</span><span class='line'><span class="n">If</span> <span class="n">all</span> <span class="n">that</span> <span class="n">works</span><span class="p">,</span> <span class="n">you</span><span class="err">&#39;</span><span class="n">re</span> <span class="n">all</span> <span class="n">set</span> <span class="n">to</span> <span class="n">start</span> <span class="n">compiling</span> <span class="n">individual</span> <span class="n">programs</span><span class="p">.</span>
</span><span class='line'><span class="n">Notice</span> <span class="n">that</span> <span class="n">all</span> <span class="n">the</span> <span class="n">source</span> <span class="n">code</span> <span class="n">assumes</span> <span class="n">tabs</span> <span class="n">every</span> <span class="mi">4</span> <span class="n">columns</span><span class="p">,</span> <span class="n">not</span> <span class="mf">8.</span>
</span></code></pre></td></tr></table></div></figure>


<!--more-->


<p>2.开始蛮兴奋地在sublime上敲，觉得脱离了IDE后怎么看怎么高大上，但慢慢发现每更改了服务端客户端的程序后，想要运行测试要在三个终端窗口敲五次命令才可以，对于习惯了一个快捷键编译运行的我实在是一场灾难，果断还是要把服务端的开发迁移到eclipse上才是上上之道。因为不熟悉Makefile的语法，对于编译的配置又是一场灾难，折腾了好久才日出来。</p>

<p>首先要配置-L选项，定位于lib所在文件路径</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">workingspace</span><span class="o">/</span><span class="n">Demo</span><span class="o">/</span><span class="n">src</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>再之后配置-l（小写L）选项，定位到具体的库名，虽然全名为libunp.a，但在配置的时候只写unp就够了,另外还要添加resolv，pthread这两个库</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">unp</span>
</span><span class='line'><span class="n">resolv</span>
</span><span class='line'><span class="n">pthread</span>
</span></code></pre></td></tr></table></div></figure>


<p>本来以为到这里就结束了，所以也就开始了悲剧的折腾之路，后来仔细对比了Makefile的显示信息，发现还要对-I（大写i）进行配置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">lib</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个路径是编译lib时所在的路径，三个配置齐全，用的时候记得include就可以使用了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[iOS应用发布流程]]></title>
    <link href="http://sonnewilling.com/blog/2014/03/01/iosying-yong-fa-bu-liu-cheng/"/>
    <updated>2014-03-01T17:20:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2014/03/01/iosying-yong-fa-bu-liu-cheng</id>
    <content type="html"><![CDATA[<h3>概述</h3>

<p>整个发布流程有四个关键词，<em>Certificates</em>，<em>Identifiers</em>，<em>Devices</em>与<em>Provisioning Profiles</em>.</p>

<p>它们的相互关系如下图所示，</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_1.png" alt="image" /></p>

<p>简单说来便是用户身份验证书（Certificates），App应用身份ID（Identifiers），可用于开发的Devices三者合一生成一份Provisioning Profile，并将此profile下载到本机双击安装后就自然可以在xcode中找到了(注意左上角的“GooGuu”在配置发布时应将Target与Project的设置调未相同选项，以避免发布失败)。</p>

<!--more-->


<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_3.png" alt="image" /></p>

<h3>步骤分解</h3>

<h4>一.Certificates证书申请</h4>

<p>付费申请到开发者账号后首先要做的便是使用它来生成一个开发或者发布的证书，这个证书是App发布的起点，有了它便表明你是名已经被苹果公司认证过的开发人员并有权力发布自己开发的App到AppStore上去。</p>

<p><a href="http://my.oschina.net/joanfen/blog/133624">iOS开发者申请发布证书</a></p>

<p>证书申请的步骤这位姐姐讲解地很详细了，不需要再一一赘述，看到第J步&mdash;<em>下载证书，双击安装</em>便可以停一下，先来看Identifier。</p>

<h4>二.Identifiers-App ID的申请</h4>

<p>Certificates是表明你开发者身份的东西，花了近100的大洋肯定不可能只满足用来开发一款App，而是会进行多方面的尝试，这时候就需要通过App ID来对我们开发出的各种应用进行唯一的标示。</p>

<p>可以简单的理解为Certificates的苹果公司给你的身份证，而App ID是你给自己开发的App的一个身份证。</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_4.png" alt="image" /></p>

<h4>三.Devices的用处</h4>

<p>开发的App可以在Xcode自带的模拟器下运行调试，想要进行真机测试的话则需要用到Devices的配置选项了。</p>

<p>当你将外置设备连入苹果电脑，进入Xcode的Window->Organizer->Devices中便会发现自己的设备名称：</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_5.png" alt="image" /></p>

<p>现在的Xcode已经集成了添加Device的功能，点击连接后的设备名称，你会在右边的窗口中发现诸如“添加该设备到开发机”之类的选项。</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_6.png" alt="image" /></p>

<p>之后到Device里简单的验证一下便可以了，你会发现自己的设备序列号已经添加到了该列表里面。</p>

<p>这个Devices列表按照第二张图的样子看应该是会在最后跟AppID与Certificate打包在一起来生成Profile文件，这样开发者身份信息，App的身份信息，可用测试的设备信息都可以随时的调用。</p>

<h4>四.Provisioning Profiles的生成与使用</h4>

<p>还是继续从第K步&mdash;<em>生成证书对应的provision File</em> 看刚刚那位姐姐的讲解吧。</p>

<p><a href="http://my.oschina.net/joanfen/blog/133624">iOS开发者申请发布证书</a></p>

<h3>发布</h3>

<p>这样一步步下来，一份完成的Profile便拿在了手上，分为Development和Distribution两种，分别用于开发与发布的使用。</p>

<p>还不清楚的话可以看下这位哥儿们的讲解，更加的专业与细致。</p>

<p><a href="http://www.cnblogs.com/cywin888/p/3263027.html">关于Certificate、Provisioning Profile、App ID的介绍及其之间的关系</a></p>

<p>接下来还剩下两步工作，一个是本地二进制文件的打包验证，一个是苹果网站的新App申请或者旧App版本更新的申请。</p>

<h4>1.苹果网站上的相关工作</h4>

<p>我们去到<a href="https://itunesconnect.apple.com/WebObjects/iTunesConnect.woa">App Product</a>这里，在网站上对App进行配置。</p>

<p>大致可以理解为通知苹果公司我将会有一个App通过Xcode进行上传，你要注意接收啊之类云云。</p>

<p>如果之前已经有旧的版本了那很简单，进入“Manage Your Apps”的页面，点击你要更新的App进入一个新的页面，里面有个Button叫“Add Version”点击进入，有一个流程页面，唯一需要注意的是<em>填写的新的版本号需要跟本地项目的Target->General的下图位置处的版本号填写相同</em>，不然在最后打包完毕验证时会发生错误导致无法提交。</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_10.png" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_9.png" alt="image" /></p>

<p>如果是第一次发布App则稍微有点麻烦，具体的还是参见刚刚那位姐姐的文章吧&hellip;</p>

<p><a href="http://my.oschina.net/joanfen/blog/133642">iOS 发布应用程序到App Store</a></p>

<h4>2.本地Xcode的相关工作</h4>

<p>将发布设备调节到下图的位置，前提是没有外置的设备连在苹果机上，其实连上也无所谓，只是文字显示不一样。</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_7.png" alt="image" /></p>

<p>然后点击Product->Archive来静待二进制文件的生成吧。</p>

<p>生成后会自动跳转到Window->Organizer->Archives，然后分别对打包好的App进行验证与最后的提交，就是这样了~</p>

<p><img src="http://sonnewilling.com/images/tec/IOSPub/pic_8.png" alt="image" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[女先生们的书]]></title>
    <link href="http://sonnewilling.com/blog/2013/11/20/nu-xian-sheng-men-de-shu/"/>
    <updated>2013-11-20T16:48:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2013/11/20/nu-xian-sheng-men-de-shu</id>
    <content type="html"><![CDATA[<p><img src="http://sonnewilling.com/images/read/ladybook.jpg" alt="image" /></p>

<p>这段时间除了看了黄仁宇的两部讲历史的书外还看了几本纪实传记之类的书，感觉都还不错，回顾了一番还真巧都是女先生们所作，果然感觉不一样。</p>

<p>最先翻起来的是齐邦媛的巨流河，记得前几年貌似火过但觉得名字有点二，跟逆流河就差一个字，本能的就闪开了，再翻开已是去年冬天，无奈看到一半对齐先生的絮絮叨叨心生厌倦也就放下了。</p>

<p>再来就是柴静的看见，爱看豆上推过来的，女先生的名字起得好，看封面长得也漂亮，比齐奶奶是好多了，所以也就通读了一番。讲第一次见白岩松的时候震惊了，貌似问她平时听什么歌，看啥书，怎么说得忘记了，当时就觉得逼格特高，差点没忍住就把这本扔下去拜读那几本去了。再然后通过她知道CCTV里也是有理想主义的存在的，其中对崔永元的印象尤深。</p>

<!--more-->


<p>在一个下午读了萧红的呼兰河传。初读的时候以为是像沈从文边城一样的小镇故事，开头的气氛文字很像，就边读边等着主角的登场，都翻到快一半了还是那种慢慢地气氛。一点点的说事儿，才发觉这特么感觉是部半自传的小说吧。写的好像都是作者儿时的故事，讲爷爷，讲他家长工，结尾在他家长工的老婆死了，现在也不知道那个长工还在不在，看完打了个冷战，想说点什么但又不知从何说起。</p>

<p>早就耳闻龙的大江大海，爱看豆上找到了李敖的大江大海骗了你，下回来是正宗的龙的作品。先不说真实与否，就觉得李二的风格很低，一点君子气息都没有，满地的想找人咬，何必呢。内容真的有些血腥，随处的17，8岁上了船再回首便是耄耋老人，父母不在。</p>

<p>2013年12月18日</p>

<p>这个月忙着做pad版的app，拜<a href="http://lusongsong.com/reed/801.html">GFW</a>所赐，费了一上午的功夫才把app提交上去坐等审核。这玩意儿有时候是挺讨厌的，做我们这行的讲究的就是个天下文章一大抄，行话叫做开源共享，协作开发。本身先天上就存在着语言弱势，沟通不便，特么又加上这么一个道道，颇有种瞎子骑破驴的感觉，自己从那闭门造车，哼哧哼哧看上去很努力，屁用都没有，操。</p>

<p>话再说回来吧，其实后面还是又捡起了齐奶奶的巨流河看了起来，蛮可以跟龙的大江大海结合起来一起看的。写得都是抗日解放那段日子的事情。齐奶奶是自传，有很多自己的小故事，但牵扯到局势的时候老有种才起了个头就煞尾了的感觉，很多事情不知是不方便说还是不想再提，总之你可以记得她的初恋，记得她妈酿黄豆酱的方法，但总会对一些我等关心的high点给略过了。记忆中就是她做学生的时候马克思主义流进校园，很多学生成立了学习小组后她还在那里啃雪莱，因为思想追求的不同而被孤立抛弃表现出了较大的情感波动，立下了不问政事的意愿，其它的你就可以领略作为一个国民党高层后代所享受的种种福利与待遇，基本上可以称之为一个落魄贵族的流浪情感史。想起之前看过的《青春之歌》和《未央歌》就感概都是学生差距真特么大，要再想想《平凡的世界》&hellip;.特么没法再想了。</p>

<p>确实，书中齐奶奶一直都是种独善其身，自我修行的态度，最终看样子也做到了，但看到大江大海时你就发现在那个年代独善其身都是需要莫大的社会背景的。大江大海从一个叫美君的故事起头，貌似就是龙的亲生母亲，兵荒马乱中流落至了台湾，自己开起杂货铺撑起一个家，每天都有逃难的人来到码头，也能看到穿得跟要饭一样的国军纷纷攘攘，各种抓人充军，小孩出去打个酱油被抓走幸运的话最后能回家探望父母的时候也是面对着一座座坟头了。有个段落是讲剧院里在演四郎探母，基本上都是中年子女陪着老父亲去看，整部戏就是唱腔伴着那些一头白发老人的抽泣完场的，读来心下不忍。</p>

<p>书中还讲了很多大陆正史不可能公布的东西，虽无法考证真伪，句句读来却很虐心。关于这个时代王鼎钧老先生也写过一本书叫《文学江湖》，遗憾并未看过，但他说齐奶奶的书是“欲说还休”，龙的是“语不惊人死不休”，而他自己的则是“欲休还说”，关于《文学江湖》并不知何如，前两者倒感觉真是贴切。又想起之前看过的一本唐德刚的《新中国三十年》，也颇有种语不惊人死不休的感觉。</p>

<p>其实龙写的其它书还是蛮油腻的，有些看不下去，堪比真实版的琼瑶言情。相比之下很喜欢迟子建的《额尔古纳河右岸》。有两本书差不多每年都会看一遍。一本是坐火车回老家的时候会看一遍《天龙八部》，别的不为，就为了看那萧峰带着燕云十八飞骑上少室山时的奔腾如虎风烟举的气势，每看到此处便热血沸腾，再待到隔空三掌便从不可一世的丁春秋手中救出阿紫后，心情更是不可抑制，完美地满足各种意淫的快感。曾跟同学讨论过，金庸笔下各种英雄层出不穷，招式兵器也是应接不暇，唯独到了萧峰这里便只有一招，或者说只有一句话，“一掌拍出”，不行就再“一掌拍出”，像丁老怪这种连拍了三掌甚至给出了掌名“亢龙有悔”的感觉已经是不能再高的待遇了。再就是从老家走前的一晚要看的《右岸》，尤其是冬天的时候，烤着暖气，开盏小黄灯，看那本书很容易就带进去了，感觉真的是在听一位老奶奶讲她这一辈子的故事，随她的讲述而跌宕起伏，跟她一起着急那染病的小鹿，然后拥被入睡，香甜无梦，再美不过。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Python Django框架网站搭建入门]]></title>
    <link href="http://sonnewilling.com/blog/2013/11/15/python-djangokuang-jia-wang-zhan-da-jian-ru-men/"/>
    <updated>2013-11-15T16:22:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2013/11/15/python-djangokuang-jia-wang-zhan-da-jian-ru-men</id>
    <content type="html"><![CDATA[<p>最近学习了下python，传说中的pyhon的框架比关键字还多果然名不虚传。想用pyhon搭个网站练练手，上网一搜果然一大把。看了下推荐各有利弊，但Django的文档比较全面，虽然说有点封闭，但也没要求多高，感觉拿来上手正合适不过了。</p>

<p><a href="http://django-chinese-docs.readthedocs.org/en/latest/index.html">Django 中文文档</a></p>

<p>这篇文章主要是个学习笔记的作用，就是根据上面的网站一步步搞起的。</p>

<p>Django是一个MVC框架，相比于Java的MVC SSH简单的不是一点半点，想之前搭SSH还通了个宵，现在看看Django的MVC简单到只有三个python文件，跟着教程一步步搭起来回过头才想起来这特么也是MVC的框架啊，自不待言。</p>

<p><img src="http://sonnewilling.com/images/tec/python-django.png" alt="image" /></p>

<p>上图是一个对Django MVC的简单示意，很容易可以看出，<code>view.py</code>是主管视图部分的，<code>model.py</code>主管模型层，遗憾没有个<code>control.py</code>，哈哈，<code>url.py</code>控制跳转，是为controller。</p>

<p>现在便一步步开始吧。</p>

<!--more-->


<h2>一.安装</h2>

<p>上周（November 6, 2013）Django才刚更新到1.6，<a href="https://docs.djangoproject.com/en/dev/releases/1.6/">Django 1.6 release notes</a>这里是一些新特性的介绍。</p>

<p>因为中文文档还是介绍的1.5的安装过程，所以先按着1.5的版本来吧。需要注意的是Django适用<code>python 2.6.5</code>到 <code>2.7</code> 的所有 Python 版本，还具有 <code>3.2</code> 和<code>3.3</code>版本的实验性支持，因为python3相对于2.x来说有了一些语法与库的更新，所以在版本选择上还是需要注意一下的，就比如在2.x中有关http请求的lib放在<code>httplib</code>中，而在python3中则在<code>urllib</code>中，倒是有个开源第三方库叫<code>httplib2</code>，看一些教程都推荐在python3中使用这个第三方库，是因为有诸如缓存之类的特性。</p>

<p>Django的安装不麻烦，<a href="https://www.djangoproject.com/download/">DownLoad</a>去这里下载压缩包，解压完进入文件目录执行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo python setup.py install</span></code></pre></td></tr></table></div></figure>


<p>就可以了。</p>

<p>可以终端进入python shell验证一下</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&gt;&gt;&gt; import django
</span><span class='line'>&gt;&gt;&gt; print(django.get_version())
</span><span class='line'>1.5</span></code></pre></td></tr></table></div></figure>


<h2>二.项目启动</h2>

<p>对于一个Django项目有两个基本的概念</p>

<ol>
<li>project，这是对整个具体的项目的称号，我们一个网站便是一个project</li>
<li>app，相对于一个project可以细分很多app，也就是功能块的意思，我们可以建立很多app，并可以在/project/settings.py进行设置，也就是号称的即插即用。</li>
</ol>


<p>开启终端，定位到一个合适的目录，键入第一行命令，生成我们的第一个Django项目</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>django-admin.py startproject mysite</span></code></pre></td></tr></table></div></figure>


<p><code>mysite</code>的名字便对应着project，这个看个人意志了。</p>

<p>妥当了后便是一个初步的网站架构</p>

<blockquote><p>mysite/</p>

<blockquote><p>   manage.py</p>

<p>   mysite/</p>

<blockquote><p>   <strong>init</strong>.py</p>

<p>   settings.py</p>

<p>   urls.py</p>

<p>   wsgi.py</p></blockquote></blockquote></blockquote>

<p>这是一个基本的目录层次</p>

<p><code>manage.py</code>是个命令行工具，可让你以各种方式与该 Django 项目进行交互，<code>settings.py</code>是对整个网站的一些基本配置，<code>urls.py</code>便是最外层的控制跳转，这里我们可以直接定位到具体的处理方法，但一般还是建议定位到相关的app，然后再让app里的<code>url.py</code>进行具体的跳转控制。<code>wagi.py</code>是一个对公共网关接口的配置，比如说放到新浪SAE的时候我们需要对这个文件进行编写配置。</p>

<p>初步介绍就是这样，shell定位到第一层的<code>mysite</code>上，输入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python manage.py runserver</span></code></pre></td></tr></table></div></figure>


<p>去<code>http://127.0.0.1:8000/</code>进行访问，便可以看到初步的效果了。</p>

<h2>三.APP激活</h2>

<p>项目启动成功后我们可以进入app的建立与关联。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python manage.py startapp polls</span></code></pre></td></tr></table></div></figure>


<p>使用上面的命令在根目录建立一个app。</p>

<blockquote><p>polls/</p>

<blockquote><p>   <strong>init</strong>.py</p>

<p>  models.py</p>

<p>   tests.py</p>

<p>   views.py</p></blockquote></blockquote>

<p>初始的app一般是这样的目录结构，一般还要自己新建一个<code>url.py</code>以便接过在根目录下<code>url.py</code>跳转控制的大旗~</p>

<p><code>model.py</code>便是模型层中相关的具体模型了，<code>view.py</code>顾名思义，在通过<code>url.py</code>控制跳转到这个文件后对请求做具体处理，一般传参为<code>request</code>而返回一个<code>HttpResponse</code>。</p>

<p>进入根目录下面的<code>settings.py</code>对app进行插入</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INSTALLED_APPS = (
</span><span class='line'>    'django.contrib.auth',
</span><span class='line'>    'django.contrib.contenttypes',
</span><span class='line'>    'django.contrib.sessions',
</span><span class='line'>    'django.contrib.sites',
</span><span class='line'>    'django.contrib.messages',
</span><span class='line'>    'django.contrib.staticfiles',
</span><span class='line'>    # Uncomment the next line to enable the admin:
</span><span class='line'>    # 'django.contrib.admin',
</span><span class='line'>    # Uncomment the next line to enable admin documentation:
</span><span class='line'>    # 'django.contrib.admindocs',
</span><span class='line'>    'polls',
</span><span class='line'>)</span></code></pre></td></tr></table></div></figure>


<p>使用</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python manage.py syncdb</span></code></pre></td></tr></table></div></figure>


<p>告诉项目对app进行同步安装。至此，一个初步的app便配置成功了。</p>

<h2>四.APP中编写第一个视图</h2>

<p>让我们编写第一个视图。打开文件 polls/views.py 并在其中输入以下 Python 代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
</span><span class='line'><span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&quot;Hello, world. You&#39;re at the poll index.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 Django 中这可能是最简单的视图了。为了调用这个视图，我们需要将它映射到一个 URL – 为此我们需要配置一个URLconf 。</p>

<p>在 polls 目录下创建一个名为 urls.py 的 URLconf 文档。 你的应用目录现在看起来像这样</p>

<blockquote><p>polls/</p>

<blockquote><p>   <strong>init</strong>.py</p>

<p>   admin.py</p>

<p>   models.py</p>

<p>   tests.py</p>

<p>   urls.py</p>

<p>   views.py</p></blockquote></blockquote>

<p>在 polls/urls.py 文件中输入以下代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">polls</span> <span class="kn">import</span> <span class="n">views</span>
</span><span class='line'><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>这是一个简单的正则匹配，大概意思便是进入根url的话则直接去执行<code>view.py</code>里的<code>index</code>方法，便是我们刚刚定义过的那个函数。</p>

<p>下一步是将 polls.urls 模块指向 root URLconf 。在 mysite/urls.py 中插入一个 include() 方法，最后的样子如下所示</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
</span><span class='line'><span class="n">admin</span><span class="o">.</span><span class="n">autodiscover</span><span class="p">()</span>
</span><span class='line'><span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^polls/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s">&#39;polls.urls&#39;</span><span class="p">)),</span>
</span><span class='line'>    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">)),</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>现在你在 URLconf 中配置了 index 视图。通过浏览器访问 <a href="http://localhost:8000/polls/">http://localhost:8000/polls/</a> ，如同你在 index 视图中定义的一样，你将看到 “Hello, world. You’re at the poll index.” 文字。</p>

<p>更多的一些视图编写方法请参见<a href="http://django-chinese-docs.readthedocs.org/en/latest/intro/tutorial03.html">这里</a></p>

<p>这里只是简单的介绍了下的客户请求服务器控制跳转处理请求并返回http对象的过程，并没有介绍如何搭配数据库模型层的运用，想进行细致的学习请移步<a href="http://django-chinese-docs.readthedocs.org/en/latest/index.html">Django 中文文档</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用Octopress搭建个人博客]]></title>
    <link href="http://sonnewilling.com/blog/2013/11/14/shi-yong-octopressda-jian-ge-ren-bo-ke/"/>
    <updated>2013-11-14T16:45:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2013/11/14/shi-yong-octopressda-jian-ge-ren-bo-ke</id>
    <content type="html"><![CDATA[<p><img src="http://sonnewilling.com/images/tec/octopress-header.png" alt="image" /></p>

<p>十月份用octopress搭建了一个个人博客，现在把大概的流程介绍一下，常用的几个命令也在这里记下来。</p>

<p><a href="http://http://octopress.org/">Octopress</a>是个利用<a href="https://github.com/mojombo/jekyll">Jekyll</a>引擎开发的博客系统。它将生成的静态页面push到我们自己的github上，可以很好的在github page上展示。号称程序员博客逼格利器</p>

<blockquote><p>A blogging framework for hackers.</p></blockquote>

<!--more-->


<h3>首先是搭建发布环境</h3>

<p>Octopress需要Ruby环境，前几天自己电脑上装的Ubantu10.0自带的Ruby1.8.7试过了不行，起码要更新到Ruby1.9.1吧，官方的建议是1.9.3.</p>

<p>安装Ruby有两个方法，一个是直接去官网下载Ruby包，解压缩，安装。另一个是使用RVM(Ruby Version Manager)来负责安装和管理Ruby的环境。</p>

<p>在Mac电脑上我直接下载安装了Rvm</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>curl -L https://get.rvm.io | bash -s stable --ruby</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rvm install 1.9.3
</span><span class='line'>rvm use 1.9.3
</span><span class='line'>rvm rubygems latest</span></code></pre></td></tr></table></div></figure>


<p>参见<a href="http://octopress.org/docs/setup/rvm/">Installing Ruby With RVM</a></p>

<p>这样便简单搞定，但Ubantu上rvm死活搞不定，网上搜了下使用第一种方法直接安装算完了，也不麻烦。</p>

<h3>然后便是安装Octopress</h3>

<p>先把Octopress从网上down下来</p>

<p><a href="https://github.com/imathis/octopress">Octopress</a></p>

<p>电脑上有git的话简单一点</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone git://github.com/imathis/octopress.git octopress</span></code></pre></td></tr></table></div></figure>


<p>解压进入项目目录安装相关依赖</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cd octopress
</span><span class='line'>gem install bundler
</span><span class='line'>rbenv rehash
</span><span class='line'>bundle install</span></code></pre></td></tr></table></div></figure>


<p>参见<a href="http://octopress.org/docs/setup/">Octopress Setup</a></p>

<p>这几步是把发布Octopress的环境搞定，还没有正式开始搭建Octopress，我在Mac上发布的博客，在Ubantu从git上check下来，也要这么来一遍才能正式使用Octopress。</p>

<p>最后安装默认的Octopress 主题。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake install</span></code></pre></td></tr></table></div></figure>


<p></p>

<h3>接下来是配置Octopress</h3>

<p>主要是对<code>_config.yml</code>进行修改，其它的话自行研究吧。</p>

<p>具体配置参见<a href="http://octopress.org/docs/configuring/">Configuring Octopress</a>写得很详细了。</p>

<p>搞定配置后可以先大体的看下样式</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate//通过引擎生成静态网页
</span><span class='line'>rake preview//本地预览</span></code></pre></td></tr></table></div></figure>


<p><a href="localhost:4000">localhost:4000</a>进行本地预览</p>

<h3>觉得差不多了就可以把Octopress发到github上了</h3>

<p>首先需要在GitHub上创建一个仓库，并将仓库名称按照：username.github.com的方式命名。待发布完毕可以直接使用<code>http://username.github.com</code>来访问博客。同时可以把博客的源码放到source分支下，并把生成的内容提交到master分支。这样随便换到哪里的电脑上都可以check下来接着写了。</p>

<p>第一步是对我们新建的目录进行建立与初始化，会提示输入你的git的账号和密码，一次确认完毕以后你每次提交都会跑到你确认的git账号下的github.com/username/username.github.com下了。</p>

<p>本地生成一下静态Html发上去就妥了</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake generate//生成
</span><span class='line'>rake deploy//发布</span></code></pre></td></tr></table></div></figure>


<h3>最后说下写博客的常用命令</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rake new_post["title"]</span></code></pre></td></tr></table></div></figure>


<p>这是新建一篇文章，存放在<code>source/_posts</code>目录下面，使用的是markdown语法，具体规则不麻烦，大家可以自己谷歌下。Mac下用Mou进行编辑很方便，Linux的话线上编辑会好一点，chrome有不少插件，其中一个叫Ma‘de，好像是作者用以表达对母亲的爱…</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'> rake generate
</span><span class='line'> git add .
</span><span class='line'> git commit -am "Some comment here." 
</span><span class='line'> git push origin source
</span><span class='line'> rake deploy</span></code></pre></td></tr></table></div></figure>


<p>使用上面几条命令生成与发布博客，中间的三条git命令是把博客的源码放到source的分支上，以便在不同的电脑上编辑博客。</p>

<p>参见<a href="http://octopress.org/docs/blogging/">Blogging Basics</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[UICollectionView与CXPhotoBrowser配合使用示例]]></title>
    <link href="http://sonnewilling.com/blog/2013/10/31/uicollectionviewyu-cxphotobrowserpei-he-shi-yong-shi-li/"/>
    <updated>2013-10-31T15:56:00+08:00</updated>
    <id>http://sonnewilling.com/blog/2013/10/31/uicollectionviewyu-cxphotobrowserpei-he-shi-yong-shi-li</id>
    <content type="html"><![CDATA[<p>UICollection是在iOS6.0中新加的功能，用于图片的集中展示，大概就是图片墙的意思。基本的使用类似于UITableView，也是设置代理，数据源，对单个的Cell可以自行定制样式。稍有不同的是在UITableView中整体样式的设置只有两种，一种是Group和Plain，而在UICollection中则有较多的选择方案，具体的实现方式需要编码人员对UICollectionViewFlowLayout自行调整。</p>

<p>开发的App中有用到这种功能，结合一个台湾哥儿们Chris Xu的开源插件CXPhotoBrower，可以达到比较好的展示图片的效果。</p>

<p>具体效果图如下：</p>

<p><img src="http://sonnewilling.com/images/tec/uicollectionImg.png" alt="image" /></p>

<p><img src="http://sonnewilling.com/images/tec/cxphotobrowserImg.png" alt="image" /></p>

<p>现在开始一步步搭建吧。</p>

<!--more-->


<h3>一.备齐原料</h3>

<p>UICollection是系统自带的，这个不用关心，CXPhotoBrowser需要自行下载引入。建议使用CocoaPods进行配置，<code>pod 'CXPhotoBrowser'</code>即可，没有用过的话那进入下面的页面按指引搭建吧。</p>

<blockquote><p><a href="https://github.com/ChrisXu1221/CXPhotoBrowser">https://github.com/ChrisXu1221/CXPhotoBrowser</a></p></blockquote>

<h3>二.UICollection的使用</h3>

<h4>1.新建一个UICollectionViewController的VC</h4>

<h4>2.初始化配置UICollectionViewFlowLayout，内嵌于UICollectionViewController中对CollectionCell进行样式管理。</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">UICollectionViewFlowLayout</span> <span class="o">*</span><span class="n">flowLayout</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UICollectionViewFlowLayout</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">对四方边界与cell之间的距离进行设置，也可以通过代理设置</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="p">[</span><span class="n">flowLayout</span> <span class="nl">setItemSize:</span><span class="n">CGSizeMake</span><span class="p">(</span><span class="mi">163</span><span class="p">,</span> <span class="mi">309</span><span class="p">)];</span>
</span><span class='line'><span class="n">flowLayout</span><span class="p">.</span><span class="n">sectionInset</span> <span class="o">=</span> <span class="n">UIEdgeInsetsMake</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'><span class="p">[</span><span class="n">flowLayout</span> <span class="nl">setMinimumLineSpacing:</span><span class="mf">5.0</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">flowLayout</span> <span class="nl">setMinimumInteritemSpacing:</span><span class="mf">5.0</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">flowLayout</span> <span class="nl">setScrollDirection:</span><span class="n">UICollectionViewScrollDirectionVertical</span><span class="p">];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UICollectionView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">CGRectZero</span> <span class="nl">collectionViewLayout:</span><span class="n">flowLayout</span><span class="p">];</span>
</span><span class='line'><span class="c1">//使用自定义的CollectionCell，出队列，与UITableView的思路相近</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="nl">registerNib:</span><span class="p">[</span><span class="n">UINib</span> <span class="nl">nibWithNibName:</span><span class="s">@&quot;PicCollectionCell&quot;</span> <span class="nl">bundle:</span><span class="nb">nil</span><span class="p">]</span> <span class="nl">forCellWithReuseIdentifier:</span><span class="n">GraphExcCellIdentifier</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">Utiles</span> <span class="nl">colorWithHexString:</span><span class="s">@&quot;#5b4d41&quot;</span><span class="p">]];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">.</span><span class="n">delegate</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">.</span><span class="n">dataSource</span> <span class="o">=</span> <span class="n">self</span><span class="p">;</span>
</span><span class='line'><span class="c1">//使用开源插件进行下拉分页的功能，读者自行谷歌</span>
</span><span class='line'><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span> <span class="nl">addInfiniteScrollingWithActionHandler:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">addPics:</span><span class="s">@&quot;&quot;</span> <span class="nl">reset:</span><span class="n">NO</span><span class="p">];</span>
</span><span class='line'><span class="p">}];</span>
</span><span class='line'><span class="n">self</span><span class="p">.</span><span class="n">collectionView</span><span class="p">.</span><span class="n">indicatorStyle</span> <span class="o">=</span> <span class="n">UIScrollViewIndicatorStyleWhite</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>3.CollectionCell的创建</h4>

<p>使用nib创建Cell，过程类似于tableCell，不再赘述了。</p>

<h4>4.Delegate与DataSource的设置</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">-</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">numberOfItemsInSection:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">images</span> <span class="n">count</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">-</span><span class="p">(</span><span class="n">UICollectionViewCell</span> <span class="o">*</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">cellForItemAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">FinanPicCollectCell</span> <span class="o">*</span><span class="n">cell</span> <span class="o">=</span> <span class="p">(</span><span class="n">FinanPicCollectCell</span> <span class="o">*</span><span class="p">)[</span><span class="n">collectionView</span> <span class="nl">dequeueReusableCellWithReuseIdentifier:</span><span class="n">GraphExcCellIdentifier</span> <span class="nl">forIndexPath:</span><span class="n">indexPath</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">id</span> <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">images</span> <span class="nl">objectAtIndex:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>    <span class="c1">//使用SDWebImage进行图片加载</span>
</span><span class='line'>    <span class="p">[</span><span class="n">cell</span><span class="p">.</span><span class="n">imageView</span> <span class="nl">setImageWithURL:</span><span class="p">[</span><span class="n">NSURL</span> <span class="nl">URLWithString:</span><span class="p">[</span><span class="n">model</span> <span class="nl">objectForKey:</span><span class="s">@&quot;smallImage&quot;</span><span class="p">]]</span>
</span><span class='line'>                   <span class="nl">placeholderImage:</span><span class="p">[</span><span class="n">UIImage</span> <span class="nl">imageNamed:</span><span class="s">@&quot;LOADING.png&quot;</span><span class="p">]];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">cell</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">等同于</span>
</span><span class='line'><span class="cm">[flowLayout setMinimumLineSpacing:5.0];</span>
</span><span class='line'><span class="cm">[flowLayout setMinimumInteritemSpacing:5.0];</span>
</span><span class='line'><span class="cm">但可针对每个Cell单独定制</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">layout:</span><span class="p">(</span><span class="n">UICollectionViewLayout</span><span class="o">*</span><span class="p">)</span><span class="nv">collectionViewLayout</span> <span class="nf">minimumLineSpacingForSectionAtIndex:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mf">10.0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">layout:</span><span class="p">(</span><span class="n">UICollectionViewLayout</span><span class="o">*</span><span class="p">)</span><span class="nv">collectionViewLayout</span> <span class="nf">minimumInteritemSpacingForSectionAtIndex:</span><span class="p">(</span><span class="n">NSInteger</span><span class="p">)</span><span class="nv">section</span><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="mf">2.0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>至此，一个基本的UICollection便简单的搭建完毕了。下面使用CXPhotoBrowser实现图片的单张浏览功能，支持左右切换与捏合放大缩小。</h3>

<h3>三.CXPhotoBrowser的使用</h3>

<p>此插件也是使用数据源代理的思路实现的，我们在载入UICollection的同时也一起对CX进行数据源的设置，另外实现两个代理方法，一个是点击单张图片获取index一遍进行此图片的放大浏览，另一个是在单张浏览功能里左右滑动时获取前后图片的index用于最上面信息栏的展示。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//pragma mark -</span>
</span><span class='line'><span class="c1">//pragma mark CXPhotoBrowserDelegate</span>
</span><span class='line'><span class="c1">//点击图片弹出详细页面</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">collectionView:</span><span class="p">(</span><span class="n">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="nv">collectionView</span> <span class="nf">didSelectItemAtIndexPath:</span><span class="p">(</span><span class="n">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="nv">indexPath</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">browser</span> <span class="nl">setInitialPageIndex:</span><span class="n">indexPath</span><span class="p">.</span><span class="n">row</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">presentViewController:</span><span class="n">self</span><span class="p">.</span><span class="n">browser</span> <span class="nl">animated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//左右切换视图事件</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">photoBrowser:</span><span class="p">(</span><span class="n">CXPhotoBrowser</span> <span class="o">*</span><span class="p">)</span><span class="nv">photoBrowser</span> <span class="nf">didChangedToPageAtIndex:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">index</span><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setText:</span><span class="p">[</span><span class="n">NSString</span> <span class="nl">stringWithFormat:</span><span class="s">@&quot;%d/%d&quot;</span><span class="p">,(</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="p">),[</span><span class="n">self</span><span class="p">.</span><span class="n">images</span> <span class="n">count</span><span class="p">]]];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//pragma mark - CXPhotoBrowserDataSource</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nf">numberOfPhotosInPhotoBrowser:</span><span class="p">(</span><span class="n">CXPhotoBrowser</span> <span class="o">*</span><span class="p">)</span><span class="nv">photoBrowser</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">photoDataSource</span> <span class="n">count</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">id</span> <span class="o">&lt;</span><span class="n">CXPhotoProtocol</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">photoBrowser:</span><span class="p">(</span><span class="n">CXPhotoBrowser</span> <span class="o">*</span><span class="p">)</span><span class="nv">photoBrowser</span> <span class="nf">photoAtIndex:</span><span class="p">(</span><span class="n">NSUInteger</span><span class="p">)</span><span class="nv">index</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">self</span><span class="p">.</span><span class="n">photoDataSource</span><span class="p">.</span><span class="n">count</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">photoDataSource</span> <span class="nl">objectAtIndex:</span><span class="n">index</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//对上方信息栏进行设置</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="n">CXBrowserNavBarView</span> <span class="o">*</span><span class="p">)</span><span class="nf">browserNavigationBarViewOfOfPhotoBrowser:</span><span class="p">(</span><span class="n">CXPhotoBrowser</span> <span class="o">*</span><span class="p">)</span><span class="nv">photoBrowser</span> <span class="nf">withSize:</span><span class="p">(</span><span class="n">CGSize</span><span class="p">)</span><span class="nv">size</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">CGRect</span> <span class="n">frame</span><span class="p">;</span>
</span><span class='line'>    <span class="n">frame</span><span class="p">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">CGPointZero</span><span class="p">;</span>
</span><span class='line'>    <span class="n">frame</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">navBarView</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">navBarView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">CXBrowserNavBarView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">frame</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">navBarView</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">]];</span>
</span><span class='line'>        <span class="n">UIView</span> <span class="o">*</span><span class="n">bkgView</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UIView</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithFrame:</span><span class="n">CGRectMake</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">bkgView</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">blackColor</span><span class="p">]];</span>
</span><span class='line'>        <span class="n">bkgView</span><span class="p">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">;</span>
</span><span class='line'>        <span class="n">bkgView</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="o">=</span> <span class="n">UIViewAutoresizingFlexibleWidth</span> <span class="o">|</span> <span class="n">UIViewAutoresizingFlexibleHeight</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">navBarView</span> <span class="nl">addSubview:</span><span class="n">bkgView</span><span class="p">];</span>
</span><span class='line'>        <span class="n">UIButton</span> <span class="o">*</span><span class="n">doneButton</span> <span class="o">=</span> <span class="p">[</span><span class="n">UIButton</span> <span class="nl">buttonWithType:</span><span class="n">UIButtonTypeCustom</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span><span class="p">.</span><span class="n">titleLabel</span> <span class="nl">setFont:</span><span class="p">[</span><span class="n">UIFont</span> <span class="nl">boldSystemFontOfSize:</span><span class="mf">12.0</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span> <span class="nl">setTitle:</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;返回&quot;</span><span class="p">,</span><span class="s">@&quot;Dismiss button title&quot;</span><span class="p">)</span> <span class="nl">forState:</span><span class="n">UIControlStateNormal</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span> <span class="nl">setFrame:</span><span class="n">CGRectMake</span><span class="p">(</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">30</span><span class="p">)];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span> <span class="nl">addTarget:</span><span class="n">self</span> <span class="nl">action:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">photoBrowserDidTapDoneButton:</span><span class="p">)</span> <span class="nl">forControlEvents:</span><span class="n">UIControlEventTouchUpInside</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span><span class="p">.</span><span class="n">layer</span> <span class="nl">setMasksToBounds:</span><span class="n">YES</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span><span class="p">.</span><span class="n">layer</span> <span class="nl">setCornerRadius:</span><span class="mf">4.0</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span><span class="p">.</span><span class="n">layer</span> <span class="nl">setBorderWidth:</span><span class="mf">1.0</span><span class="p">];</span>
</span><span class='line'>        <span class="n">CGColorSpaceRef</span> <span class="n">colorSpace</span> <span class="o">=</span> <span class="n">CGColorSpaceCreateDeviceRGB</span><span class="p">();</span>
</span><span class='line'>        <span class="n">CGColorRef</span> <span class="n">colorref</span> <span class="o">=</span> <span class="n">CGColorCreate</span><span class="p">(</span><span class="n">colorSpace</span><span class="p">,(</span><span class="n">CGFloat</span><span class="p">[]){</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">});</span>
</span><span class='line'>        <span class="p">[</span><span class="n">doneButton</span><span class="p">.</span><span class="n">layer</span> <span class="nl">setBorderColor:</span><span class="n">colorref</span><span class="p">];</span>
</span><span class='line'>        <span class="n">doneButton</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="o">=</span> <span class="n">UIViewAutoresizingFlexibleLeftMargin</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">navBarView</span> <span class="nl">addSubview:</span><span class="n">doneButton</span><span class="p">];</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">UILabel</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setFrame:</span><span class="n">CGRectMake</span><span class="p">((</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">60</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">40</span><span class="p">)];</span>
</span><span class='line'>        <span class="c1">//[self.imageTitleLabel setCenter:navBarView.center];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setTextAlignment:</span><span class="n">NSTextAlignmentCenter</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setFont:</span><span class="p">[</span><span class="n">UIFont</span> <span class="nl">boldSystemFontOfSize:</span><span class="mf">20.</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setTextColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">whiteColor</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setBackgroundColor:</span><span class="p">[</span><span class="n">UIColor</span> <span class="n">clearColor</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setText:</span><span class="s">@&quot;&quot;</span><span class="p">];</span>
</span><span class='line'>        <span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span><span class="p">.</span><span class="n">autoresizingMask</span> <span class="o">=</span> <span class="n">UIViewAutoresizingFlexibleHeight</span> <span class="o">|</span> <span class="n">UIViewAutoresizingFlexibleRightMargin</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span> <span class="nl">setTag:</span><span class="n">BROWSER_TITLE_LBL_TAG</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">navBarView</span> <span class="nl">addSubview:</span><span class="n">self</span><span class="p">.</span><span class="n">imageTitleLabel</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">navBarView</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">//pragma mark - PhotBrower Actions</span>
</span><span class='line'><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">photoBrowserDidTapDoneButton:</span><span class="p">(</span><span class="n">UIButton</span> <span class="o">*</span><span class="p">)</span><span class="nv">sender</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">self</span> <span class="nl">dismissViewControllerAnimated:</span><span class="n">YES</span> <span class="nl">completion:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>至此一个简答的图片墙加详细浏览的功能便做完了，欢迎交流新的想法。</h3>
]]></content>
  </entry>
  
</feed>
